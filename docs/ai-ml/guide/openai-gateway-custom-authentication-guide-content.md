Intelligent applications that use Azure OpenAI services through platform-native Azure deployments offer a seamless user authentication and authorization approach for developers. However, edge case scenarios present unique complexities that require additional architecture designs. Scenarios include topologies such as non-Azure hosted applications, the use of external identity providers, or deploying multiple clients accessing the same Azure OpenAI instances. In these scenarios, introducing a gateway in front of Azure OpenAI can provide significant improvement with a layer of security that ensures consistency in authentication to deployed instances. 

This article explores the following key scenarios when authenticating with Azure OpenAI services. 
- Client applications authenticated with an external identity provider 

- Client applications authenticated with certificates 

- Multiple client applications accessing a shared Azure OpenAI instance 

- Client applications accessing multiple Azure OpenAI instances

Each scenario describes the challenges that they introduce, and the benefits introduced by including a gateway. 

> [!IMPORTANT]
> The following guidance is suitable for any gateway implementation, including Azure API Management. The architecture diagrams represent the component generically in most scenarios to illustrate this. 

## Client applications authenticated with an external identity provider 

:::image type="complex" source="_images/Scenario-ExternalIdentity.png" lightbox="_images/Scenario-ExternalIdentity.png" alt-text="Diagram that shows a conceptual architecture of injecting a gateway between an intelligent application and Azure OpenAI.":::
Diagram that shows a conceptual architecture of injecting a gateway between an intelligent application and Azure OpenAI and using an external Identity Provider.
:::image-end:::
*Figure 1: Client applications auuthenticate with external identity provider.*



### Scenario use cases for external identity providers

In the scenario where a user operates an intelligent application that employs an external Identity Provider (IdP), like Okta or Auth0, the authentication process may differ. If the application is not hosted within Azure, the use of managed identities for authentication is not possible. In this case, API keys become essential as they offer a secure and straightforward method for these external applications to interact with Azure OpenAI, facilitating effective tracking and control of API usage. 

When designing an architecture for accessing Azure OpenAI services, the following use cases may apply: 

- User authentication is managed by a Microsoft Entra ID tenant external to the Azure OpenAI instance. 

- User authentication is managed by an external OpenID Connect (OIDC) enabled identity provider, such as Okta or Auth0. 

### Introduce a gateway to improve Azure OpenAI access security and maintainability 

:::image type="complex" source="_images/Solution-ExternalIdentity.png" lightbox="_images/Solution-ExternalIdentity.png" alt-text="Diagram that shows a conceptual architecture of injecting a gateway between an intelligent application and Azure OpenAI.":::
Diagram that shows a conceptual architecture of injecting a gateway between an intelligent application and Azure OpenAI and using an external Identity Provider.
:::image-end:::
*Figure 2: Introduce a gateway to allow authentication with an external identity provider.*

Introducing a gateway in this scenario allows server-side control to authorize access to Azure OpenAI using a managed identity regardless of the user authentication mechanism via an identity provider. The managed identity eliminates the need to manage API keys for Azure OpenAI instances in client application code, while improving security using Azure role-based access control (RBAC). 

Using a gateway in this scenario, it will validate the authenticated user access tokens, such as a JSON Web Token (JWT), generated by the identity provider before granting authorization to the backing Azure OpenAI instance. When authenticating with Azure OpenAI, the gateway uses its assigned managed identity with least-privileged role-assignment to make requests for completions. 

#### Tips for client applications authenticated with external identity providers  

- Additional client scopes can be added to your application registration in your identity provider to enable granular permission to consumers. These scopes allow client applications to request permission to perform specific operations in your gateway, including access to Azure OpenAI. 

- This scenario is straightforward to configure using inbound policies in Azure API Management with the validate-jwt policy to enforce the existence and validity of a supported JWT. 


#### Reasons to avoid a gateway for client applications authenticated with external identity providers 

When implementing a single, Azure deployed client application to access Azure OpenAI, configuration of user authentication and authorization may be easier within the application than at the gateway level. With this approach, your Azure deployed application can also be assigned the necessary RBAC to securely authenticate with Azure OpenAI directly. 

## Client applications authenticated with certificates 

:::image type="complex" source="_images/Scenario-ClientCertificate.png" lightbox="_images/Scenario-ClientCertificate.png" alt-text="Diagram that shows the scenarion where Intelligent Applications use client certificates for authentication.":::
Diagram that shows the scenario where Intelligent Applications use client certificates for authentication.
:::image-end:::
*Figure 3: Intelligent Applications may use client certificates for authentication..*

### Scenario use cases for client certificate authentication 

When designing an architecture for accessing Azure OpenAI services, the following use cases may apply: 

- User authentication requirements cannot be met solely by OIDC providers. 

- Authentication is made from machine-to-machine (M2M), where there is no user interaction. 

- Client applications authenticate users via a client certificate, which can be validated by downstream services. 

Azure OpenAI does not support client certification authentication natively, requiring the use of an API key to authenticate client application requests to the Azure OpenAI instance. In order to facilitate authentication using client digital certificates for Intelligent applications or APIs that utilize this method, we can rely on an API Gateway to request and verify client certificates during the TLS handshake. 

### Introduce a gateway to handle client certificate validation with secure access to Azure OpenAI 

:::image type="complex" source="_images/Solution-ClientCertificate.png" lightbox="_images/Solution-ClientCertificate.png" alt-text="Diagram that shows the scenarion where Intelligent Applications use client certificates for authentication.":::
Diagram that shows the solution that introduces a gateway to allow Intelligent Applications use client certificates for authentication.
:::image-end:::
*Figure 4: Introduce a gateway to allow Intelligent Applications to use client digital certificates for authentication..*

Offloading client certification validation to a gateway provides server-side control to authorize access for valid client applications to Azure OpenAI. Additionally, taking advantage of managed identity to authenticate the gateway with Azure OpenAI instances reduces the complexity of managing API keys. 

Deploying an Azure Key Vault alongside a gateway to store the root certificate authority (CA) will ensure that client certificate validation is managed in a centralized location, reducing maintenance overhead. 

Using a gateway in this scenario, it is the responsibility of the gateway to [validate the client digital certificate presented by the Intelligent Application](https://learn.microsoft.com/en-us/azure/api-management/api-management-howto-mutual-certificates-for-clients#policy-to-validate-client-certificates) and check the issuer, expiration, thumbprint, and revocation lists. A key vault can increase the security of handling the digital certificates issued to Intelligent Applications to authorize access to the Generative AI Services API.  

When authenticating with Azure OpenAI, the gateway uses its assigned managed identity with least-privileged role-assignment to make requests for completions. 

In this scenario, the API Gateway can receive and verify the certificate presented by the Intelligent Application and abstract the API from the validation process. In implementations such as Azure API Management, you can use policies to verify the certificates presented by the clients and easily integrate with Azure Key Vault. Self-signed certificates should not be used for authentication purposes. 

There are advantages that can surpass the disadvantages of using an API Gateway: centralized security with consistent security policies to evaluate client digital certificates. The API Gateway can also reduce complexity offloading the responsibility of certificate verification from the service, you can also enhance performance with cached responses, data compression and TLS termination. It can make the architecture more flexible, in case of authentication changes, which will be handled by the API Gateway and not the service. 

#### Tips for client applications authenticated with client certificates 

- When validating certificates, verify the entire certificate chain, including the root CA and intermediate certificates. Full verification ensures the authenticity of the certificate and prevents unauthorized access. 

- Regularly rotate and renew client certificates to minimize the risk of certificate compromise. Automate this process using Azure Key Vault to ensure certificates are always up to date. Setting alerts for upcoming certificate expirations will also prevent service disruption at the gateway. 

- Use a policy on the API Gateway to ensure certificate verification is consistent for all clients. 

#### Reasons to avoid a gateway for client applications authenticate with client certificates 

There are a few disadvantages to the use of an API Gateway to facilitate client certificates to authenticate the Intelligent Applications: the API Gateway can become a single point of failure, there is an increase in latency as a new appliance is deployed in front of the API, and there could be vendor lock-in, if the decision is made to buy off the shelf versus implementing an API Gateway. 

In smaller applications or environments where security and certificate management can be handled directly within the application without a gateway, the added complexity may outweigh the benefits. You must carefully assess your specific needs, resource availability, and the criticality of your applications before deciding to implement a gateway for client certificate authentication. 

    *Figure 7: Code snippet to implement Microsoft Entra ID JWT token validation in Azure API Management API policies.*

### Configuring Azure API Management to authenticate with Azure OpenAI Service using Managed Identity

1. For Azure API Management to call the Azure OpenAI Service APIs without API keys, the system-assigned managed identity must be enabled. This will provide you with an Object ID that you can associate with your Azure OpenAI Service instances.

    :::image type="content" source="_images/openai-gateway-custom-authentication-apim-system-managed-identity.png" lightbox="_images/openai-gateway-custom-authentication-apim-system-managed-identity.png" alt-text="Screenshot showing configuration for system assigned managed identity in Azure API Management.":::
    *Figure 8: System assigned managed identity configuration for Azure API Management.*

1. From your Azure OpenAI Service instances, using access control (IAM), create a role assignment for your Azure API Management managed identity with the role **Cognitive Services OpenAI User**.

    :::image type="content" source="_images/openai-gateway-custom-authentication-apim-managed-identity-role-assignment.png" lightbox="_images/openai-gateway-custom-authentication-apim-managed-identity-role-assignment.png" alt-text="Screenshot showing adding a role assignment for the system assigned managed identity in Azure API Management.":::
    *Figure 9: Add least-privileged role assignment to Azure API Management's managed identity scoped to the Azure OpenAI resource.*

1. To authenticate with the Azure OpenAI Service, an access token must be provided in the Authorization header of the request to the API endpoints. In the inbound policy of the Azure OpenAI API in Azure API Management, the authentication-managed-identity policy in conjunction with the set-header policy to ensure the request is authenticated.

    ```xml
    <policies>
      <inbound>
        <authentication-managed-identity resource="https://cognitiveservices.azure.com" output-token-variable-name="msi-access-token" ignore-error="false" />
        <set-header name="Authorization" exists-action="override">
          <value>@("Bearer " + (string)context.Variables["msi-access-token"])</value>
        </set-header>
      </inbound>
    </policies>
    ```

    *Figure 10: Code snippet to implement authentication to Azure OpenAI service using managed identity in Azure API Management API policies.*

## Scenario considerations

With a well-configured Azure OpenAI gateway in place, let's consider additional points to aid in achieving the successful outcome objectives within this scenario.

### User-assigned managed identity

An alternative approach to implementing the managed identity for Azure API Management is to use a user assigned. Unlike the system-assigned managed identity, which is managed for you by Azure, user-assigned managed identity allows you to create and manage it. This gives you more control over the identity implementation and its assigned roles.

To implement this approach, you need to create the user assigned managed identity within your resource group and assign it the same Cognitive Services OpenAI User role to the Azure OpenAI instances. The user-assigned managed identity has an associated client ID that is needed for configuring the authentication-managed-identity policy in Azure API Management. This must be set as the client-id parameter.

```xml
<policies>
  <inbound>
    <authentication-managed-identity resource="https://cognitiveservices.azure.com" client-id="00000000-0000-0000-0000-000000000000" output-token-variable-name="msi-access-token" ignore-error="false" />
    <set-header name="Authorization" exists-action="override">
      <value>@("Bearer " + (string)context.Variables["msi-access-token"])</value>
    </set-header>
  </inbound>
</policies>
```

*Figure 11: Code snippet to implement authentication to Azure OpenAI service using a user-assigned managed identity in Azure API ManagementAPI policies.*

Using a user assigned managed identity can provide more flexibility and control over the authentication process. However, it also requires additional management and configuration on your part.

### External identity providers

In scenarios where you already have an existing external identity provider, enabling the use of Microsoft Entra ID to build an identity platform for your application is not be feasible. Taking advantage of your existing identity platform ensures that your team feel familiar with their tools to focus on building core functionality.

When working with external OpenID Connect (OIDC) supported identity providers, ensure that a client is configured within that identity provider. This is equivalent to configuring your application within Microsoft Entra ID, discussed in the scenario. With this configured, configuring the validate-jwt policy requires configuration for the external well-known OpenID configuration path.  

```xml
<policies>
  <inbound>
    <validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized. Access tokenis missing or invalid.">
      <openid-config url="{external-identity-provider-well-known-openid-path}" />
    </validate-jwt>
  </inbound>
</policies>
```

*Figure 12: Code snippet to implement external identity provider JWT token validation in Azure API Management API policies.*

Additional configuration for required claims can be provided the same as the scenario solution.

## Contributors

*This article is maintained by Microsoft. It was originally written by the following contributors.*

Principal authors:

- [Lizet Pena De Sola](https://www.linkedin.com/in/lizetp/) | Senior Customer Engineer
- [Bappaditya Banerjee](https://www.linkedin.com/in/bappaditya-banerjee-8860ba7/) | Senior Customer Engineer  
- [James Croft](https://www.linkedin.com/in/jmcroft/) | Customer Engineer

*To see nonpublic LinkedIn profiles, sign in to LinkedIn.*

## Summary

This article provides an effective solution for implementing alternative authentication mechanisms for intelligent applications communicating with Azure OpenAI Service instances through a gateway proxy. By using an identity provider for user authentication combined with managed identity for authenticating with Azure OpenAI without the need for managed keys, teams can take advantage of fine-grained access control their Azure OpenAI endpoints and models.  

## Related resources

- [Role-based access control for Azure OpenAI](/azure/ai-services/openai/how-to/role-based-access-control)
- [Use managed identities in Azure API Management](/azure/api-management/api-management-howto-use-managed-service-identity)
- [Policies in Azure API Management](/azure/api-management/api-management-howto-policies)
- [Authentication and authorization to APIs in Azure API Management](/azure/api-management/authentication-authorization-overview)
- [Protect an API in API Management using OAuth 2.0 and Microsoft Entra ID](/azure/api-management/api-management-howto-protect-backend-with-aad)
