# Disaster recovery for the Azure Analytics platform: Architecture

## Use case definition
To support this worked example, the fictitious firm “Contoso” will be used with an Azure Data Platform based upon Microsoft Reference Architectures.

### Data Service - Component View
Contoso has implemented the following foundational Azure structure, which is a subset of the [Enterprise Landing Zone](/azure/cloud-adoption-framework/ready/landing-zone/#azure-landing-zone-conceptual-architecture).
![Azure landing zone diagram](../media/dr-for-azure-analytics-alz-architecture.png)

*The numbers in the following descriptions correspond to the preceding diagram above.*

### Contoso’s Azure Foundations - Workflow

1. **Enterprise Enrollment** - Contoso’s top parent enterprise enrollment within Azure reflecting its commercial agreement with Microsoft, its organizational account structure and available Azure subscriptions. It provides the billing foundation for subscriptions and how the digital estate is administered.
1. **Identity and Access Management** – The components required to provide identity, authentication, resource access and authorization services across Contoso’s Azure footprint.
1. **Management Group and Subscription Organization** - A scalable group hierarchy aligned to the data platform’s core capabilities, allowing operationalization at scale using centrally managed security and governance where workloads have clear separation.  Management groups provide a governance scope above subscriptions.
1. **Management Subscription** - A dedicated subscription for the various management level  functions of required to support the data platform.
1. **Connectivity Subscription** - A dedicated subscription for the connectivity functional of the data platform enabling it to identify named services, determine secure routing and communication across and between servicese and alsoand share data externally including to/from on-premises.
1. **Landing Zone Subscription** – One-to-many subscriptions for Azure native, online applications, internal and external facing workloads and resources.
1. **Dev Ops Platform** - The DevOps Platform which supports the Azure foundation & Data Platform. This contains the code base source control repository and CI/CD pipelines enabling automated deployments of IaC.

>[!NOTE]
>Many customers still retain a large IaaS footprint. To provide recovery capabilities across IaaS, the key component to be added is Azure Site recovery. Site Recovery will orchestrate and automate the replication of Azure VMs between regions, on-premises virtual machines and physical servers to Azure, and on-premises machines to a secondary datacenter.

Within this foundational structure, Contoso has implemented the following elements to support its enterprise business intelligence needs:
![data platform diagram](../media/AzureAnalyticsEndToEnd.png)
*Contoso's data platform*

Contoso’s Data Platform - Workflow  

The workflow is read left to right, following the flow of data:
- **Data Sources** - The sources or types of data which the data platform can consume from  
- **Ingest** - The Platform’s capability to ingest data from various sources of varying structure and speed. This design reflects a [Lambda architecture](/azure/architecture/data-guide/big-data/#lambda-architecture)
- **Store** - The capability to securely store data at scale that has been ingested onto the platform
- **Process** - The Platform’s capability to process data, making it “fit for purpose” for downstream processes, i.e. cleansing, standardizing, modeling etc.   The pre-processing of data typically ensures that it's in a “position and a condition, ready for use”
- **Enrich** - The capability to enhance data processed on the platform via statistical,  Machine Learning or other modelling techniques or prebuilt Azure AI Services
-  **Serve** - The Platform’s capability to shape and present data for downstream consumption
- **Data Consumers** - The individuals, applications or downstream processes which consume data from the platforms’ various serving touchpoints
- **Discover and Govern** - The Platform’s capabilities to govern the data it contains and ensure it is indexed, discoverable/searchable, well-described, with full lineage and is transparent to its end users and consuming processes.
- **Platform** - The foundation upon which the platform is built, i.e. Contoso’s Azure Foundations as described above.

>[!NOTE]
>For many customers, the conceptual level of the Data Platform Reference architecture used will align, but the physical implementation may vary, i.e. ELT (extract, load, transform) capabilities may be provided by Azure Data Factory, data modelling by Azure SQL server, etc. To address this concern, the [Stateless vs Stateful](link to this section) section will provide guidance

For the Data Platform, Contoso has selected the lowest recommended production service tiers for all components and has chosen to adopt a “Redeploy on Disaster” DR strategy based upon an operating cost-minimization approach.  

This will provide a baseline understanding of the DR process and levers available to customers to uplift this posture.

## Azure service and component view

The following tables presents a breakdown of each Azure service and component used across the Contoso – Data platform, with options for DR uplift.
>[!NOTE]
>The tables below are organized by stateful vs stateless services

#### Foundational Azure services

# [Stateful services](#tab/stateful)

|Service/Component|Component Recovery Responsibility|Workload/Config Recovery Responsibility|Contoso SKU selection|DR Uplift Options|Notes|
|---|---|---|---|---|---|
| Azure Active Directory including role entitlements | Microsoft                         | Microsoft                               | Premium P1             | Native SaaS resiliency                                                                                                  | [Advancing service resilience in Azure Active Directory](https://azure.microsoft.com/en-us/blog/advancing-service-resilience-in-azure-active-directory-with-its-backup-authentication-service/) |
| Azure Key Vault                                    | Microsoft                         | Microsoft                               | Standard               | Native SaaS resiliency                                                                                                  | [Azure Key Vault availability and redundancy](/azure/key-vault/general/disaster-recovery-guidance)</br></br>[Additional steps will be required if HSM's are used](/azure/key-vault/managed-hsm/disaster-recovery-guide)                                                   |
| Recovery   Services Vault                          | Microsoft                         | Microsoft                               |     Default   (GRS)    | Enabling   Cross Region Restore enabling data restoration in the secondary, paired   region.                          | While   LRS is available, it requires configuration activities off the default   setting                                              |
| Azure DevOps           | Microsoft                                 | Microsoft                               | DevOps Services       | [DevOps service and data resiliency is part of its SaaS offering](/azure/devops/organizations/security/data-protection?view=azure-devops#data-availability)

# [Stateless services](#tab/stateless)

|Service/Component|Component Recovery Responsibility|Workload/Config Recovery Responsibility|Contoso SKU selection|DR Uplift Options|Notes|
|---|---|---|---|---|---|
| Management Groups                                  | Microsoft                         | Microsoft                               | N/A                    | N/A                                                                                                                   | Covered as part of the Azure service                                                                                                  |
| Subscriptions                                      | Microsoft                         | Microsoft                               | N/A                    | N/A                                                                                                                   | Covered as part of the Azure service                                                                                                  |
| Azure Monitor                                      | Microsoft                         | Microsoft                               | N/A                    | N/A                                                                                                                   | Covered as part of the Azure service                                                                                                  |
| Microsoft   Defender for Cloud                     | Microsoft                         | Microsoft                               | N/A                    | N/A                                                                                                                   | Covered as part of the Azure service                                                                                                  |
| Cost   Management                                  | Microsoft                         | Microsoft                               | N/A                    | N/A                                                                                                                   | Covered as part of the Azure service                                                                                                  |
| Azure   DNS                                        | Microsoft                         | Microsoft                               | Single   Zone – Public | N/A                                                                                                                   | Azure DNS is highly available by design                                                                                               |
| Network   Watcher                                  | Microsoft                         | Microsoft                               | N/A                    | N/A                                                                                                                   | Covered as part of the Azure service                                                                                                  |
| Virtual   Networks, including Subnets, UDR & NSGs  | Contoso                           | Contoso                                 | N/A                    | [The VNET can be replicated into the secondary, paired region](/azure/virtual-network/virtual-network-disaster-recovery-guidance#business-continuity) | [A VNet is created within the scope of a region](/azure/virtual-network/virtual-network-disaster-recovery-guidance#overview)                            |
| Resource   Groups                                  | Contoso                           | Contoso                                 | N/A                    | N/A                                                                                                                   | Covered as part of the Azure service                                                                                                  |
| Azure   Firewall                                   | Contoso                           | Contoso                                 | Standard               | [Azure Firewall can be created with Availability Zones for increased availability](/azure/firewall/deploy-availability-zone-powershell)                                   | [Azure Firewall is highly available by design](/azure/firewall/features#built-in-high-availability)                                                   |
| Azure   DDOS                                       | Microsoft                         | Contoso                                 | N/A                    | N/A                                                                                                                   | Covered as part of the Azure service
| ExpressRoute – Circuit | Contoso, connectivity partner & Microsoft | Connectivity partner & Microsoft        | Standard              | [Site-to-Site VPN connection can be used as a backup for ExpressRoute](/azure/expressroute/use-s2s-vpn-as-backup-for-expressroute-privatepeering)</br></br>[ExpressRoute can be uplifted to use private peering, delivering a geo-redundant service](/azure/expressroute/designing-for-disaster-recovery-with-expressroute-privatepeering)</br></br>[ExpressRoute also has high availability designs available](/azure/expressroute/designing-for-high-availability-with-expressroute)              | [The ExpressRoute has inbuilt redundancy, which each circuit consisting of two connections to two Microsoft Enterprise edge routers (MSEEs) at an ExpressRoute Location from the connectivity provider/clients network edge](/azure/expressroute/expressroute-introduction#redundancy)</br></br>[ExpressRoute premium circuit will enable access to all Azure regions globally](/azure/expressroute/expressroute-faqs#what-is-expressroute-premium) |
| VPN Gateway            | Contoso                                   | Contoso                                 | VpnGw1                | A VPN   Gateway can be deployed into an Availability Zone with the VpnGw#AZ SKU’s to   provide a zone redundant service.                                                                                                                                                                                                                                                                                                                                                                                                                                                          | ExpressRoute also requires a VPN gateway, which can also be uplifted via to a zone redundant service, the ErGW#AZ SKU’s.                                                                                                                                                                                                                                                                                                                                                                                   |
| Load Balancer          | Contoso                                   | Contoso                                 | Standard              | [A Load Balancer can be configured for Zone redundancy within a region with availability zones. If this is the case, the data path will survive as long as one zone within the region remains healthy.](/azure/load-balancer/load-balancer-standard-availability-zones)</br></br>[Depending on the primary region, a cross-region load balancer can be deployed for a highly available, cross regional deployment](/azure/load-balancer/cross-region-overview#build-cross-region-solution-on-existing-azure-load-balancer) | [Azure Traffic Manager is a DNS-based traffic load balancer. This service supports the distribution of traffic for public-facing applications across the global Azure regions. This will provide protection from a regional outage within a high availability design.](/azure/traffic-manager/traffic-manager-overview)

---

#### Data platform-specific services

# [Sateful services](#tab/stateful)

| Service/Component | Component Recovery Responsibility | Workload/Config Recovery Responsibility | Contoso SKU selection | DR Uplift Options | Notes |
|---|---|---|---|---|---|
| Storage Account – Azure Data Lake Gen2             | Microsoft                         | Contoso                                 | LRS                                      | [Storage Accounts have a broad range of data redundancy options from primary region redundancy up to secondary region redundancy](/azure/storage/common/storage-redundancy)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | GRS is recommended to uplift redundancy, providing a copy of the data in the paired region                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Azure Event Hubs                                   | Microsoft                         | Contoso                                 | Standard                                 | An Event Hub namespace can be created with availability zones enabled. This resiliency can be extended to cover a full region outage with Geo-disaster recovery.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | [By design, Event Hubs geo-disaster recovery does not replicate data, therefore there are several considerations to keep in mind for fail-over and fallback[(/azure/event-hubs/event-hubs-geo-dr?tabs=portal#considerations)                                                                                                                                                                                                                                                                                          |
| Azure IoT Hubs                                     | Microsoft                         | Contoso                                 | Standard                                 | [IoT Hub Resiliency can be uplifted by a cross regional HA implementation.](/azure/iot-hub-ha-dr#achieve-cross-region-ha)<br></br>[Microsoft provides the following guidance for HA/DR options](/azure/iot-hub-ha-dr#choose-the-right-hadr-option)                                                                                                                                                                                                                                                                                                                                                                                                      | IoT Hub provides Microsoft-Initiated Failover and Manual Failover by replicating data to the paired region for each IoT hub.                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Azure Stream Analytics                             | Microsoft                         | Contoso                                 | Standard                                 | [Azure Stream Analytics does not provide automatic geo-failover, but you can achieve geo-redundancy by deploying identical Stream Analytics jobs in multiple Azure regions.](/azure/stream-analytics/geo-redundancy)                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Azure Stream Analytics is a fully managed (PaaS) offering on Azure.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Azure Machine Learning                             | Microsoft & Contoso               | Contoso                                 | General Purpose – D Series instances     | [Azure Machine Learning depends on multiple Azure services, some of which are provisioned in the customer’s subscription. As such, the customer remains responsible for the high-availability configuration of these services](/azure/machine-learning/how-to-high-availability-machine-learning#understand-azure-services-for-azure-machine-learning)                                                                                                                                                                                                                                                                                                                             | [Azure Machine Learning itself does not provide automatic failover or disaster recovery](/azure/machine-learning/how-to-high-availability-machine-learning)                                                                                                                                                                                                                                                                                                                                                           |
| Azure Synapse – Data Explorer Pools                | Microsoft                         | Contoso                                 | Computed Optimized Gen2                  | [Azure Data Explorer persistence and compute resiliency can be uplifted by provisioning using an availability zone.](/azure/data-explorer/business-continuity-overview#high-availability-of-azure-data-explorer)<br></br>This can be further uplifted by a deployment in a secondary region, under a DR configuration.                                                                                                                                                                                                                                                                                                                                                                  | [Azure Data Explorer doesn't provide automatic protection against the outage of an entire Azure region.](/azure/data-explorer/business-continuity-overview#outage-of-an-azure-region)                                                                                                                                                                                                                                                                                                                                 |
| Power BI                                           | Microsoft                         | Microsoft                               | Power BI Pro                             | Native SaaS resiliency                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Power BI uses Azure Availability Zones to protect Power BI reports, applications and data from datacenter failures.<br></br>[Power BI uses Azure Availability Zones to protect Power BI reports, applications and data from datacenter failures](/power-bi/enterprise/service-admin-failover#what-does--high-availability--mean-for-power-bi-)<br></br>In the case of regional failure, Power BI will fail over to a new region, usually in the same geographical location, as noted in the Microsoft Trust Center.             |
| Azure Cosmos DB                                    | Microsoft                         | Microsoft                               | Single Region Write with Periodic backup | [Single-region accounts may lose availability following a regional outage. This can be uplifted to a single write region and at least a second (read) region and enable Service-Managed failover.](/azure/cosmos-db/high-availability#availability)</br></br>[It is strongly recommended that Azure Cosmos accounts used for production workloads to enable automatic failover. In the absence of this configuration, the account will experience loss of write availability for all the duration of the write region outage, as manual failover will not succeed due to lack of region connectivity.](/azure/cosmos-db/high-availability#availability) | [The following guidance described the impact of a region outage based upon the cosmos configuration.](/azure/cosmos-db/high-availability#what-to-expect-during-a-region-outage)                                                                                                                                                                                                                                                                                                                                       |
| Azure Data Share                                   | Microsoft                         | Microsoft                               | N/A                                      | [Azure Data Share's resiliency can be uplifted by HA deployment into a secondary region.](/azure/data-share/disaster-recovery#achieving-business-continuity-for-azure-data-share)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | [Azure Data Share’s resiliency can be uplifted by HA deployment into a secondary region.](/azure/data-share/disaster-recovery#achieving-business-continuity-for-azure-data-share)     
| Purview           | Microsoft                         | Contoso                                 | N/A                   | N/A               | [As at Jan 2022, Azure Purview does not support automated BCDR. Until that support is added, you are responsible to take care of backup and restore activities.](/azure/purview/disaster-recovery#achieve-business-continuity-for-azure-purview) |                                                                                                                                                                                                                                                                                                                               |
# [Stateless services](#tab/stateless)

| Service/Component | Component Recovery Responsibility | Workload/Config Recovery Responsibility | Contoso SKU selection | DR Uplift Options | Notes |
|---|---|---|---|---|---|
| Azure Synapse – Pipelines                          | Microsoft                         | Contoso                                 | Computed Optimized Gen2                  | Native SaaS resiliency                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | If Self-Hosted Data Pipelines are used, they will remain the customer’s responsibility for recovery from a disaster                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| Azure Cognitive Services                           | Microsoft                         | Microsoft                               | Pay-as-you-go                            | [The APIs for Cognitive Services are hosted by Microsoft-managed data centers.](/azure/cognitive-services/what-are-cognitive-services#regional-availability)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | [If Cognitive Services has been deployed via customer deployed docker containers, recovery remains the responsibility of the customer](/azure/cognitive-services/cognitive-services-container-support)                                                                                                                                                                                                                                                                                                                |
| Azure Synapse – Spark Pools                        | Microsoft                         | Contoso                                 | Computed Optimized Gen2                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | [As of Dec 2021 - Azure Synapse Analytics only supports disaster recovery for dedicated SQL pools and doesn’t support it for Apache Spark pools](https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/microsoft-defender-for-key-vault-deploy-to-azure-synapse/ba-p/3201308#:~:text=Azure%20Synapse%20Analytics%20only%20supports%20disaster%20recovery%20for,snapshots%20for%20disaster%20recovery%20of%20dedicated%20SQL%20pools.)                                                                                                   |
| Azure Synapse – Serverless and Dedicated SQL Pools | Microsoft                         | Contoso                                 | Computed Optimized Gen2                  | Native SaaS resiliency                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | [Azure Synapse Analytics performs a standard geo-backup once per day to a paired data center. The RPO for a geo-restore is 24 hours](/azure/cloud-adoption-framework/migrate/azure-best-practices/analytics/azure-synapse#disaster-recovery)<br></br>If Self-Hosted Data Pipelines are used, they will remain the customers responsibility recovery from a disaster.                                                                                                                                                       |
| Azure Cognitive Search                             | Microsoft                         | Microsoft                               | Standard S1                              | [Multiple services in separate regions can extend this further.](/azure/search/search-performance-optimization#multiple-services-in-separate-geographic-regions)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | In Cognitive Search business continuity (and disaster recovery) is achieved through multiple search services.</br></br>[Note - There is no built-in mechanism for disaster recovery. If continuous service is required in the event of a catastrophic failure, the recommendation is to have a second service in a different region and implementing a geo-replication strategy to ensure indexes are fully redundant across all services.](/azure/search/search-performance-optimization#disaster-recovery-and-service-outages) |

---

## Stateful vs Stateless Components
The speed of innovation across the Microsoft product suite and Azure, in particular, means the component set that we have used for this worked example will quickly evolve. In an effort to future-proof this and enable the extension of this guidance to components not explicitly covered in this document. This section provides some instruction based upon the coarse-grain classification of state.  

A component/service can be described as “stateful if it is designed to remember preceding events or user interactions… Stateless means there is no record of previous interactions, and each interaction request has to be handled based entirely on information that comes with it"

For a DR scenario that calls for redeployment:
- Components/services which are “stateless”, i.e. Azure functions, Azure Data factory pipelines, etc. - can be redeployed from source control with at least a smoke test to validate availability before being introduced into the broader system
- Components/services which are “stateful”, i.e. Azure SQL database, storage accounts etc. – require more attention
    - When procuring the component, a key decision will be the selection of the data redundancy feature. This is typically a trade-off between availability and durability with operating costs
    - Datastore components will also need a data backup strategy. In some cases, this will be covered by the data redundancy features i.e. Storage Accounts, while others will need a separate backup process i.e. SQL Databases
    - If required, the component can be redeployed from source control with a smoke-test to validate that it is available with the correct configuration
    - Either using the data redundancy feature or a backup dataset, the component can be rehydrated. Once completed, the dataset should be checked to ensure it’s complete, accurate and validate the current date/timestamp
        - Depending on the nature of the backup process, the backup datasets may require validation before being applied. Backup process corruption/error may result in earlier backup being used in place of the latest available
    - Any delta between component date/timestamp and the current date should be addressed by re-executing or replaying the data ingestion processes from that point forward
    - Once the component dataset is up to date, the component can be introduced into the broader system

## Other key services
This section contains HA/DR guidance for other key Azure Data components and services.

- Azure Databricks - DR guidance can be found in the [product documentation](/azure/databricks/administration-guide/disaster-recovery)
- Azure Analysis Services - HA guidance can be found in the [product documentation](azure/analysis-services/analysis-services-bcdr)
- Azure Database for MySQL 
    - Flexible Server HA guidance can be found in the [product documentation](/azure/mysql/flexible-server/concepts-business-continuity)
    - Single Server HA guidance can be found in the [product documentation](/azure/mysql/single-server/concepts-business-continuity)
- Azure SQL

## Next Steps
Now that you have learned about the scenario's architecture, you can learn about the [scenario details](../articles/dr-for-azure-data-platform-scenario-details)