# Precision Medicine Pipeline with Genomics

The growing scale, complexity, and security requirements of genomics make it an ideal candidate for moving to the cloud. Azure offers an ideal solution:

- Scientists plan on sequencing hundreds of thousands of genomes in coming years. The task of storing and analyzing this data requires significant computing power and storage capacity. With data centers around the world, Azure can meet these demands.
- Azure is certified for major global security and privacy standards, such as ISO 27001.
- Azure complies with the security and provenance standards that HIPAA establishes for personal health information.

This document outlines a cloud solution for genomics that uses Azure. A key component is [Microsoft Genomics](https://azure.microsoft.com/services/genomics/). This service offers an optimized secondary analysis implementation that can process a 30x genome in a few hours. Standard technologies can take days. Microsoft Genomics uses a high-performance engine that is optimized for these tasks:

- Reading large files of genomic data
- Processing them efficiently across many cores
- Sorting and filtering the results
- Writing the results to output files

To maximize throughput, this engine operates a BWA aligner and a GATK HaplotypeCaller variant caller. It also uses several other components that make up standard genomics pipelines. Examples include duplicate marking, base quality score recalibration, and indexing. In a few hours, the engine can process a single genomic sample on a single multi-core server. The processing starts with raw reads and produces aligned reads and variant calls.

The Microsoft Genomics service controller manages the processing of batches of genomes distributed across pools of machines in the cloud. It maintains a queue of incoming requests, distributes them to servers running the genomics engine, monitors their performance and progress, and evaluates the results. It ensures that the service runs reliably and securely at scale, behind a secure web service API. Clients don’t need to deal with the complexity of managing and updating their hardware and software, and can rely on fast, efficient execution of an accurate best-practices genomics pipeline. The results can be easily connected to tertiary analysis and machine learning services.

## Potential use cases

This Azure solution provides a framework for end to end genomic analysis and reporting using a combination of Azure native and open source tools. The goal is to support a clinical genomics workflow that can be automated to take data from a sequencer, move it through secondary and tertiary analysis, and ultimately provide data that is ready to be consumed by the clinician.

## Architecture

<img src="Genomics_1.0.png" width="75%"/>

Azure Data Factory orchestrates the workflow:

1. Azure Data Factory transfers the initial sample file to Azure Blob Storage. The file is in FASTQ format.
1. Microsoft Genomics runs secondary analysis on the file.
1. Microsoft Genomics stores the output in Azure Blob Storage in one of these formats:

   - Variant call format (VCF)
   - Genomic VCF (GVCF)

1. Jupyter Notebook annotates the output file. The notebook runs on Azure Databricks.
1. Azure Data Lake Storage stores the annotated file.
1. Another Jupyter notebook merges the file with additional datasets and analyzes the data.
1. Azure Data Lake Storage stores the processed data.
1. Clinicians view the findings:

   - Power BI dashboards display the data.
   - Azure Healthcare APIs adds the clinical data to patient electronic health records (EHRs) as part of Fast Healthcare Interoperability Resources (FHIR) bundles.

## Components

- [Azure Data Factory](https://docs.microsoft.com/azure/data-factory/introduction) is used for the overall orchestration and automation of the workflow. Specifically, we use [pipelines](https://docs.microsoft.com/azure/data-factory/concepts-pipelines-activities) for the data movement to Azure and in sequence to trigger each step of the workflow.

- [Azure Blob Storage](https://docs.microsoft.com/azure/storage/blobs/) provides the initial landing zone for the fastq as well as the output target for the vcf/gvcf generated by Microsoft Genomics. Additionally, blob storage has [tiering](https://docs.microsoft.com/azure/storage/blobs/storage-blob-storage-tiers) functionality that allows the fastq files to be archived to inexpensive long term storage after being processed.

- [Microsoft Genomics](https://docs.microsoft.com/azure/genomics/) performs secondary analysis and outputs the vcf/gvcf to Azure Blob Storage.

- [Azure Databricks](https://docs.microsoft.com/azure/databricks/) provides the additional computational resources to run Jupyter Notebooks for annotation of the vcf/gvcf and to merge the annotated file with other relevant datasets and run the final analysis against the merged data, which is then output to Azure Data Lake Store Gen2.

- [Azure Data Lake Storage Gen2](https://docs.microsoft.com/azure/storage/blobs/data-lake-storage-introduction) provides the final landing zone(s) for the annotated vcf/gvcf as well as the outputs from the final merged data set where it is ready to be consumed by the downstream systems.

- [Power BI](https://docs.microsoft.com/power-bi/fundamentals/) dashboards can be populated with the results and used by a clinician to visualize the final dataset.

- [Azure API for FHIR](https://docs.microsoft.com/azure/healthcare-apis/fhir/) leveraging our [Health Architectures](https://github.com/microsoft/health-architectures) can pass a FHIR bundle to the EHR with the resulting clinical data.

## Considerations

- Given the sensitive nature of the data, governance and security should be established following the guidelines found in the [Cloud Adoption Framework](https://docs.microsoft.com/azure/cloud-adoption-framework/) and [Enterprise Scale Landing Zones](https://docs.microsoft.comazure/cloud-adoption-framework/ready/enterprise-scale/).
- Customers subject to HIPAA/HITECH Act compliance obligations should review [Microsoft Azure HIPAA/HITECH Act Implementation Guidance](https://aka.ms/azurehipaaguidance), as well as the white paper “[Practical guide to designing secure health solutions using Microsoft Azure](https://aka.ms/azureindustrysecurity)” to learn about concrete steps needed to maintain compliance on Azure and to better understand what it takes to adopt a cloud platform in a secure manner.
  - Components of the solution presented are in scope for HIPAA per the [Microsoft Azure Compliance Offerings](https://azure.microsoft.com/mediahandler/files/resourcefiles/microsoft-azure-compliance-offerings/Microsoft%20Azure%20Compliance%20Offerings.pdf), any substitute components should be validated against the list found in the appendix before being incorporated into the overall solution.

## Related resources

- Link to publication around new MS Gen testing and pricing info
- [Genomics Quickstart Starter Kit](https://github.com/microsoft/Genomics-Quickstart)
- [Burrows-Wheeler Aligner](http://bio-bwa.sourceforge.net/)
- [Genome Analysis Toolkit](https://gatk.broadinstitute.org/hc/en-us)
