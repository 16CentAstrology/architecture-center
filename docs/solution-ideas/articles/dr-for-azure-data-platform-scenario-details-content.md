# Disaster recovery for the Azure Analytics platform: Scenario Details

## Data service topology

At a high-level the data service topology for Contoso’s data platform can be illustrated as:
![Contoso data service topology](../media/dr-for-azure-data-contoso-service-topology.png)

## DR Impact vs Customer Activity 
The following tables present a breakdown of Contoso activity required across DR events of varying impacts.

### Table 1: Foundation services

| Service/Component                                                                                                                                                                 | Contoso SKU selection | Azure Data Center failure* | Availability Zone failure                                             | Azure Regional failure                                                                                                             | Notes                                                                                                                                                                                                                              |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|---------------------------|-----------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Azure Active Directory including role entitlements                                                                                                                                | Premium P1            | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Management Groups                                                                                                                                                                 | N/A                   | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Subscriptions                                                                                                                                                                     | N/A                   | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Azure Key Vault                                                                                                                                                                   | Standard              | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Azure Monitor                                                                                                                                                                     | N/A                   | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Micrsosoft Defender for Cloud                                                                                                                                                     | N/A                   | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Cost Management                                                                                                                                                                   | N/A                   | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Azure DNS                                                                                                                                                                         | N/A                   | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Network Watcher                                                                                                                                                                   | N/A                   | N/A                       | N/A                                                                   | N/A                                                                                                                                |                                                                                                                                                                                                                                    |
| Recovery Services Vault                                                                                                                                                           | Default (GRS)         | N/A                       | N/A                                                                   | N/A                                                                                                                                | Cross Region Restore will enable DR drills and the customer failing over to the secondary region.                                                                                                                                  |
| Virtual Networks, including Subnets, UDR & NSGs                                                                                                                                   | N/A                   | N/A                       | N/A                                                                   | Contoso would need to redeploy the Foundation and Data platform VNET’s with their attached UDRs & NSG’s into the secondary region. | [Traffic Manager](/azure/traffic-manager/traffic-manager-overview) can be used to geo-route traffic between regions which hold replica VNET structures. If they have the same address space, they cannot be connected to the on-premises network, as it would cause routing issues.</br></br>At the time of a disaster and loss of a VNet in one region, you can connect the other Vnet in the available region, with the matching address space to your on-premises network. |
| Resource Groups                                                                                                                                                                   | N/A                   | N/A                       | N/A                                                                   | Contoso would need to redeploy the Foundation and Data platform Resource groups into the secondary region.                         | This activity would be mitigated by implementing the “Warm Spare” strategy, having the network and resource group topology available in the secondary region.                                                                      |
| Azure Firewall                                                                                                                                                                    | Standard              | N/A                       | Contoso would need to validate availability and redeploy if required. | Contoso would need to redeploy the Foundation Azure Firewalls into the secondary region.                                           | Azure Firewall can be created with [Availability Zones](/azure/firewall/deploy-availability-zone-powershell) for increased availability.</br></br>Once again, a “Warm Spare” strategy would mitigate this activity.                                                                                |
| Azure DDOS                                                                                                                                                                        | Standard              | N/A                       | N/A                                                                   | Contoso would need to create a Ddos protection plan for the Foundation’s VNETs within the secondary region.                        | This activity would be mitigated by implementing the “Warm Spare” strategy, having the network available in the secondary region, enabling the DDOS protection plan to be created before the disaster event.                       |
| ExpressRoute – Circuit                                                                                                                                                            | Standard              | N/A                       | N/A                                                                   | N/A                                                                                                                                | The physical circuit would remain the responsibility of Microsoft and the connectivity partner to recover.                                                                                                                         |
| VPN Gateway                                                                                                                                                                       | VpnGw1                | N/A                       | Contoso would need to validate availability and redeploy if required. | Contoso would need to redeploy the Foundation VPN Gateways into the secondary region.                                              | VPN Gateways can be created with [Availability Zones](/azure/vpn-gateway/about-zone-redundant-vnet-gateways) for increased availability.</br></br>Once again, a “Warm Spare” strategy would mitigate this activity.                                                                                  |
| Load Balancer                                                                                                                                                                     | Standard              | N/A                       | Contoso would need to validate availability and redeploy if required. | Contoso would need to redeploy the Foundation Load Balancers into the secondary region.                                            | Depending on the primary region, either a [zone redundant](/azure/load-balancer/load-balancer-standard-availability-zones) or [cross-regional](/azure/load-balancer/cross-region-overview#build-cross-region-solution-on-existing-azure-load-balancer) design could be used to uplift this posture.                                                                                                            |
| Azure DevOps                                                                                                                                                                      | DevOps Services       | N/A                       | N/A                                                                   | N/A                                                                                                                                | DevOps Services is [built upon the Azure backbone](/azure/devops/organizations/security/data-protection?view=azure-devops#built-on-azure) and uses [Azure blob storage with geo-replication](/azure/devops/organizations/security/data-protection?view=azure-devops#data-redundancy) to ensure resiliency.                                                                                                            |

### Table 2: Data platform services

| Service/Component                                                                           | Contoso SKU selection                    | Azure Data Center failure*                                             | Availability Zone failure                                             | Azure Regional failure                                                                                                                   | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|---------------------------------------------------------------------------------------------|------------------------------------------|-----------------------------------------------------------------------|-----------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Storage Account – Azure Data Lake Gen2                                                      | LRS                                      | N/A                                                                   | Contoso would need to validate availability and redeploy if required. | Contoso would need to redeploy the Data Platform Storage Accounts and rehydrate them with data in the secondary region.                  | Storage Accounts have a broad range of [data redundancy](/azure/storage/common/storage-redundancy) options from primary region redundancy up to secondary region redundancy.</br></br>For Secondary region redundancy data is replicated to the [secondary region asynchronously](/azure/storage/common/storage-redundancy#redundancy-in-a-secondary-region). A failure that affects the primary region may result in data loss if the primary region cannot be recovered. Azure Storage typically has an RPO of less than 15mins.                                                                                                                                                                                                                                                                                                                                              |
| Azure Synapse – Pipelines                                                                   | Computed Optimized Gen2                  | N/A                                                                   | N/A                                                                   | Contoso would need to deploy and [restore](/azure/synapse-analytics/sql-data-warehouse/sql-data-warehouse-restore-from-geo-backup) the Data Platform Azure Synapse Analytics into the secondary region and redeploy the pipelines. | Automatic restore points are [deleted after 7 days](/azure/synapse-analytics/sql-data-warehouse/backup-and-restore#restore-point-retention).</br></br>[User-defined restore points](/azure/synapse-analytics/sql-data-warehouse/backup-and-restore#user-defined-restore-points) are available. Currently (July 2022), there is a ceiling of 42 user-defined restore points that are automatically deleted after 7 days.</br></br>Can also perform a DB restore in the local or remote region, and then immediately PAUSE the instance.  This will only incur storage costs – and have zero compute costs.  This offers a means to keep a ”live” DB copy at specific intervals. |
| Azure Event Hubs                                                                            | Standard                                 | Contoso would need to validate availability and redeploy if required. | Contoso would need to validate availability and redeploy if required. | Contoso would need to redeploy the Event Hub into the secondary region.                                                                  | The Event Hub namespace could be created with [availability zones enabled](/azure/event-hubs/event-hubs-geo-dr?tabs=portal#availability-zones), addressing the Data center outage risk.</br></br>This resiliency can be extended to cover a full region outage with [Geo-disaster recovery](/azure/event-hubs/event-hubs-geo-dr).
| Azure IoT Hubs                                                                              | Standard                                 | N/A                                                                   | N/A                                                                   | Contoso would need to redeploy the IoT Hub into the secondary region.                                                                    | IoT Hub provides [Intra-Region HA](/azure/iot-hub/iot-hub-ha-dr#intra-region-ha) and will automatically use an availability zone if created in a [predefined set of Azure regions](/iot-hub/iot-hub-ha-dr#availability-zones)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Azure Stream Analytics                                                                      | Standard                                 | N/A                                                                   | N/A                                                                   | Contoso would need to redeploy the Stream Analytics into the secondary region.                                                           | A key feature of Stream Analytics is its ability to recover from [Node failure](/azure/stream-analytics/stream-analytics-concepts-checkpoint-replay#job-recovery-from-node-failure-including-os-upgrade)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Azure Cognitive Services                                                                    | Standard                                 | N/A                                                                   | N/A                                                                   | N/A                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| Azure Machine Learning                                                                      | General Purpose – D Series instances     | Contoso would need to validate availability and redeploy if required. | Contoso would need to validate availability and redeploy if required. | Contoso would need to redeploy Machine Learning into the secondary region.                                                               | While the Machine Learning infrastructure is managed by Microsoft; the [associated resources are managed by the customer](/azure/machine-learning/how-to-high-availability-machine-learning#understand-azure-services-for-azure-machine-learning). Only Key Vault is highly available by default. </br></br>Depending on the service criticality supported, Microsoft recommends a [multi-regional deployment](/azure/machine-learning/how-to-high-availability-machine-learning#plan-for-multi-regional-deployment).                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| Azure Synapse – Data Explorer Pools                                                         | Compute Optimised Gen2                   | N/A                                                                   | N/A                                                                   | Contoso would need to redeploy Azure Synapse – Data Explorer Pools and pipelines into the secondary region.                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| Azure Synapse – Spark Pools                                                                 | Compute Optimised Gen2                   | N/A                                                                   | N/A                                                                   | Contoso would need to redeploy Azure Synapse – Spark  Pools and pipelines into the secondary region.                                     | If an [external Hive metastore](/azure/synapse-analytics/spark/apache-spark-external-metastore) is used, this will also need a recovery strategy in place. </br></br>[Azure Site Recovery](/azure/site-recovery/site-recovery-sql) can be used for a SQL Server metastore.</br></br>[A MySQL](/azure/mysql/concepts-business-continuity#recover-from-an-azure-regional-data-center-outage) metastore would use the geo-restore feature or cross-regional read replicas. |
| Azure Synapse – Serverless and Dedicated SQL Pools                                          | Compute Optimised Gen2                   | N/A                                                                   | N/A                                                                   | Contoso would need to deploy and [restore](/azure/synapse-analytics/sql-data-warehouse/sql-data-warehouse-restore-from-geo-backup) the Data Platform Azure Synapse Analytics into the secondary region.                            | Automatic restore points are [deleted after 7 days](/azure/synapse-analytics/sql-data-warehouse/backup-and-restore#restore-point-retention).</br></br>[User-defined restore points](/azure/synapse-analytics/sql-data-warehouse/backup-and-restore#user-defined-restore-points) are available. Currently (July 2022), there is a ceiling of 42 user-defined restore points that are automatically deleted after 7 days.</br></br>Can also perform a DB restore in the local or remote region, and then immediately PAUSE the instance.  This will only incur storage costs – and have zero compute costs.  This offers a means to keep a ”live” DB copy at specific intervals.                                                                                                                                                                                                                                                                          |
| Power Bi                                                                                    | Power Bi Pro                             | N/A                                                                   | N/A                                                                   | N/A                                                                                                                                      | The customer will [not need to do anything](/power-bi/admin/service-admin-failover#how-does-microsoft-decide-to-fail-over-) if the outage is decided/declared by Power BI team.</br></br>Note – A Failed-over Power Bi service instance [only supports read operations](https://docs.microsoft.com/en-us/power-bi/admin/service-admin-failover#what-is-a-power-bi-failover-).</br></br>Reports that use Direct Query or Live connect won't work during a failover.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Azure Cosmos DB                                                                             | Single Region Write with Periodic backup | N/A                                                                   | N/A                                                                   | Contoso should monitor, ensuring there are [enough provisioned RUs](/azure/cosmos-db/high-availability#what-to-expect-during-a-region-outage) in the remaining regions to support read & write activities.           | [Single-region accounts may lose availability](/azure/cosmos-db/high-availability#availability) following a regional outage. To ensure high availability at all times it's recommended to set up your Azure Cosmos DB account with a single write region and at least a second (read) region and enable Service-Managed failover.                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Azure Cognitive Search                                                                      | Standard S1                              | Contoso would need to validate availability and redeploy if required. | Contoso would need to validate availability and redeploy if required. | Contoso would need to redeploy the Cognitive Search into the secondary region.                                                           | There is no [built-in mechanism for disaster recovery](/azure/search/search-performance-optimization#disaster-recovery-and-service-outages).</br></br>Implementing multiple Cognitive Search replicas across [availability zones](/search/search-performance-optimization#availability-zones) will address the data centre outage risk.</br></br>[Multiple services in separate regions](/search/search-performance-optimization#multiple-services-in-separate-geographic-regions) will address both availability zone and regional outages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| Azure Data Share                                                                            | N/A                                      | Contoso would need to validate availability and redeploy if required. | Contoso would need to validate availability and redeploy if required. | Contoso would need to redeploy the Data Share into the secondary region.                                                                 | Azure Data Share is not currently supported by [Availability Zones](/azure/availability-zones/az-region).</br></br>Uplifting Data Share to a [HA deployment](/azure/data-share/disaster-recovery#achieving-business-continuity-for-azure-data-share) will address each of these outage risks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Purview                                                                                     | N/A                                      | N/A                                                                   | Contoso would need to validate availability and redeploy if required. | Contoso would need to deploy an instance of Purview into the secondary region.                                                           | This activity would be mitigated by implementing the “Warm Spare” strategy, having a second instance of Azure Purview available in the secondary region.</br></br>A ”Warm Spare” approach has the following [key callouts](/azure/purview/disaster-recovery#achieve-business-continuity-for-azure-purview):</br></br>The primary and secondary Azure Purview accounts cannot be configured to the same Azure Data Factory, Azure Data Share and Synapse Analytics accounts, if applicable. As a result, the lineage from Azure Data Factory and Azure Data Share cannot be seen in the secondary Azure Purview accounts.</br></br>The integration runtimes are specific to an Azure Purview account. Hence, if scans must run in primary and secondary Azure Purview accounts in parallel, multiple self-hosted integration runtimes must be maintained.  |

- The Azure Data Center Failure scenario covers the situation where the impacted region does not have [Availability Zones](/en-us/azure/availability-zones/az-overview) offered
- If new/updated configuration or releases occurred at the point of the disaster event, that should be checked and redeployed (if required) as part of the work to bring the platform up to the current date
- In the case of a regional outage, Storage accounts which are geo-redundant would be available in the secondary region as LRS. Additional configuration would need to be applied to uplift these in the secondary region to be geo-redundant

>[!NOTE]
> This section is intended as general guidance. The vendor’s documentation on disaster recovery, redundancy and backup should be consulted for the correct approach for a new component/service under consideration

## Next steps
Now that you have learned about the scenario details, you can learn about [recommendations related to this scenario](../dr-for-azure-data-platform-recommendations)