This article describes the considerations for an Azure Kubernetes Service (AKS) cluster that runs a workload in compliance with the Payment Card Industry Data Security Standard (PCI-DSS). 

> This article is part of a series. Read the [introduction](aks-pci-intro.yml) here.

![GitHub logo](../../../_images/github.png) [GitHub: Azure Kubernetes Service (AKS) Baseline Cluster for Regulated Workloads](https://github.com/mspnp/aks-baseline-regulated) demonstrates the regulated infrastructure. This implementation provides a microservices application. It's included to help you experience the infrastructure and illustrate the network and security controls. The application does not represent or implement an actual PCI DSS workload.

## Maintain a Vulnerability Management Program

**Requirement 5**&mdash;Protect all systems against malware and regularly update anti-virus software or programs 

|Requirement|Responsibility|
|---|---|
|[Requirement 5.1](#requirement-51)|Deploy anti-virus software on all systems commonly affected by malicious software (particularly personal computers and servers).|
|[Requirement 5.2](#requirement-52)|Ensure that all anti-virus mechanisms are maintained as follows:|
|[Requirement 5.3](#requirement-53)|Ensure that anti-virus mechanisms are actively running and cannot be disabled or altered by users, unless specifically authorized by management on a case-by-case basis for a limited time period.  |
|[Requirement 5.4](#requirement-54)|Ensure that security policies and operational procedures for protecting systems against malware are documented, in use, and known to all affected parties.|


**Requirement 6**&mdash;Develop and maintain secure systems and applications

|Requirement|Responsibility|
|---|---|
|[Requirement 6.1](#requirement-61)|Establish a process to identify security vulnerabilities, using reputable outside sources for security vulnerability information, and assign a risk ranking (for example, as “high,” “medium,” or “low”) to newly discovered security vulnerabilities. |
|[Requirement 6.2](#requirement-62)|Ensure that all system components and software are protected from known vulnerabilities by installing applicable vendor-supplied security patches. Install critical security patches within one month of release. |
|[Requirement 6.3](#requirement-63)|Develop internal and external software applications (including web-based administrative access to applications) securely, as follows:
|
|[Requirement 6.4](#requirement-64)|Follow change control processes and procedures for all changes to system components. The processes must include the following:|
|[Requirement 6.5](#requirement-65)|Address common coding vulnerabilities in software-development processes as follows:|
|[Requirement 6.6](#requirement-66)|For public-facing web applications, address new threats and vulnerabilities on an ongoing basis and ensure these applications are protected against known attacks by either of the following methods:|
|[Requirement 6.7](#requirement-67)|Ensure that security policies and operational procedures for developing and maintaining secure systems and applications are documented, in use, and known to all affected parties.|

***

### Requirement 5.1

#### Your responsibilities

### Requirement 5.2

#### Your responsibilities

### Requirement 5.3

#### Your responsibilities

### Requirement 5.4

#### Your responsibilities

***

### Requirement 6.1

#### Your responsibilities

### Requirement 6.2

#### Your responsibilities

### Requirement 6.3

#### Your responsibilities

### Requirement 6.4

#### Your responsibilities

### Requirement 6.5

#### Your responsibilities

### Requirement 6.6

#### Your responsibilities

### Requirement 6.7

#### Your responsibilities



Like any cloud solution, a PCI workload is subject to network, identity, and data threats. Common examples of sources that take advantage of workload and system vulnerabilities are viruses or software updates that produce undesirable results. Detect threats early and respond with mitigation in a timely manner. Build critical alerts for workload activities and extend those alerts to core system processes that _must_ be running at all times, such as antivirus or file-integrity monitoring (FIM) tools. Have an accountable response plan and a team that investigates the alerts and takes action. 

### Role of a security agent
Security agents are software that monitor the system and can help detect threats early. Because AKS is a managed service, AKS control plane prohibits certain operations. For example, you cannot install and run virtual machine scale set agents directly on VM nodes. 

So, you have to deploy a security agent that will run in a pod on every node. There are several third-party software that are specialized for Kubernetes. Popular choices include Twistlock, Aquasec, and others. There are also open-source options such as Falco. When deployed, they run as agents that look for unsual cluster activities and can generate reports and alerts.

> [!IMPORTANT]
> It's your responsibility to protect the workload, infrastructure, and the deployment pipelines by choosing an appropriate software. Do due dilligence in understanding the feature set offered by each software and the depth of scanning that it can do. Consider software developed by reputable vendors.

## Antimalware considerations
Some threats can get injected through malicious software. An antimalware software is a security agent that can protect the system from known virus attacks and continuously monitor for new threats. 

> [!TIP]
>
> The reference implementation provides a placeholder `DaemonSet` deployment to run an antimalware agent. The agent will run on every node VM in the cluster. Place your choice of antimalware software in this deployment.

### Antimalware software choice

Choose software that is specialized in Kubernetes and containers. Some third-party options are Twistlock and Aquasec. In AKS, traditional agent-based VM solutions are not permitted including Azure Defender for servers.

The software should block common threats and monitor new threats. Make sure the software is regularly updated, tested, and replaced if found unsuitable. 

Security agents run with high privileges. This means they scan everything that runs in the cluster not just the workload. They must not become a data exfiltration source. Also, supply chain attacks are common for containers. Use defense-in-depth strategy and make sure the software and all the dependencies are trusted. 

### Scanning scope

Run the agent in the cluster that scans all user and system node pools. Even though AKS uses system node pools for its runtime system binaries, the underlying compute is still your responsibility. Also run the software on external assets that participate in cluster operations. Some examples include jump boxes, build agents, and container images that interact with the cluster. 

Restrict permissions for modifying the deployment and other critical security tools. Keep a separate set of permissions for the workload and the system processes. 

When scanning, the agent should not block or interfere with the critical operations of the cluster, such as by locking files. 

### Monitor compliance
You're responsible for monitoring the operations and responding to the alerts of the antimalware software.

- Track compliance for each requirement for audit purposes. 
- Keep a log trail of scanning activities. Ensure the scanning process does not log any cardholder data scraped from disk or memory. 
- Set alerts for activities that might cause unexpected lapse in compliance. The alerts shouldn't be turned off inadvertently.

## Software patches

Software patches can introduce vulnerabilities. Make sure that patches are safe. Patches must be checked and installed by an account with critical access privileges. 

Use file-integrity monitoring (FIM) tools that detect file changes and send notifications. Monitor those notifications to make sure unauthorized additions, modifications, and deletions aren't made.

> [!TIP]
>
>The reference implementation provides a placeholder `DaemonSet` deployment to run a FIM tool. The software will run on every node VM. Place your choice of software in this deployment.

### Critical security patches

- Weekly, AKS provides new images for the user node pool. Those images aren't applied automatically. Apply them as soon as they're available. You can  update manually or automatically through Node Image Update. For more information, see Azure Kubernetes Service (AKS) node image upgrade the AKS Release Notes.

    For the AKS-managed control plane, AKS installs or upgrades the security patches. This does not include the system node pools. <!-- confusion-->

- Every 24 hours, AKS nodes automatically download and install operating system and security patches, individually. Your firewall must not block this traffic if you want to receive those updates.

    Consider enabling reporting capabilities on the security agent to get information about the applied updates. 
    Some security updates require a reboot. Be sure to review the alerts and take the action to ensure minimum or zero application downtime with those reboots. An open-source option to perform reboots in a controlled manner is Kured (Kubernetes reboot daemon).

- Extend the patching process to resources outside the cluster that you provision such as jump boxes, build agents, and so on.

### Secure software development
<!--refine-->
Microsoft SDL (Security Development Lifecycle) process is used in engineering practice for all Azure services, including AKS. More details about Microsoft SDL is available at: https://www.microsoft.com/en-us/securityengineering/sdl

Ensure you have a similar SDL.

### Container images
All software installed in the cluster is sourced from your container registry. Similar to the application code, have your team scrutinize Azure and third-party images (DockerFile and OCI) and also use static analysis tools. 
<!-- what are these. (they might be integrated with ACR) It seems they build secure images.-->

Azure Container Registry with continuous scanning in Azure Security Center will help identify vulnerable images and various risks it can pose to the workload. For more information about image scan and risk control, see [Container security](/azure/security-center/container-security). There are specialized third-party tools that detect the integrity of the DockerFile and the manifests. Some third-party options are Dockle and Trivy.

- Start scanning container images from the initial stages when the cluster is created. Make the scanning process a part of your continuous integration/continuous deployment pipelines. 

- Usually images contain more binaries than what are required. Reducing the image size not only has performance benefits but also will limit the attack surface. For example, using distroless will minimize the base Linux images.

- Only use signed images. 
- Understand (and accept) the base image provided by Azure and how it complies with CIS benchmarks.

### Change control processes

- Best practice is to use Infrastructure-as-Code such as, Bicep, Azure Resource Manager, Pelomi, Terraform, and so on. All pipeline changes must be reviewed with same standards as code changes. 

    Infrastructure changes can result in undesirable resource states, for instance exposing endpoints publicly. Don't only rely on Azure Policy to catch those changes. Have a review process that checks all those changes.
 
- Ensure your deployment pipelines are gated in such a way that both cluster bootstrapping images and your workload have passed through a review and/or quarantine gate. Maintain history about how and what processes were used before they were pulled to the cluster. 

- Have rollback procedures for faulty deployments. For infrastructure, consider redeploying a previous version. A common approach is Blue-Green deployments. However, they are are not suitable in some cases, can be more expensive. For workloads, including databases, have a strategy that works for your specific topology and scoped to your units of deployment.
<!--vague-ometer high!-->

- Deployment pipelines have higher privileges and can orchestrate system-altering changes, by design. As part of your change management system, automate the discovery of changes. Review the pipelines before changes are made. Each reviewer in areas of code, infrastructure, and pipeline should have working knowledge of the system. Significant changes should be applied to new and updated systems and well documented. 

- Document the pipeline changes and the output. Consider capturing the output of ARM what-if as part of this process https://docs.microsoft.com/azure/azure-resource-manager/templates/template-deploy-what-if for your infrastructure changes.

### Production and pre-production environments

Maintain separate production and pre-production environments and roles that operate in those environments. 

- Do not use your production cluster for development/test purposes. For example, don't install "bridge to Kubernetes" in your production clusters. Use dedicated clusters for non-production workloads. 

- Production environments should not allow network access to pre-production environments, and vice versa.

- Use different identities for pre-production and production environments. 

    Use Azure AD groups for groups such as cluster administrators, or pipeline principals. Don't use generalized or common groups as access controls. Don't reuse those groups between pre-production and production clusters. One way is to use the cluster name (or other opaque identifier) in the group name, to be explicit on memberships.

    Use Azure RBAC roles appropriately between environments. Typically more roles and rights are assigned pre-production environments. 
    
    Pre-production-only identities (granted to pipelines or software engineering teams), should not be granted access in production. Conversely, any production-only identities (such as pipelines) should not be granted access in pre-production clusters.

    Do not use the same user-managed identity for any resource in pre-production and in production. This recommendation applies to all resources that support user-managed identity, not just the resource deployed in your cluster. As a rule, each Azure resource should have its own identity.

- Use just-in-time(JIT) access for hig-privilege access, including on pre-production clusters if possible. Use conditional access policies on both pre production and production clusters.

- Remove default configuration data, sample data, and well-known test data in the system before deploying to production. That data is used to perform end-to-end health checks and performance and correctness monitoring through simulated transactions. Do not use cardholder data for test purposes. 

## Next

Restrict access to cardholder data by business need to know. Identify and authenticate access to system components. Restrict physical access to cardholder data

> [!div class="nextstepaction"]
> [Implement Strong Access Control Measures](aks-pci-identity.yml)