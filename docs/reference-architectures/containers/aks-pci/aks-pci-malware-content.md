This article describes the considerations for an Azure Kubernetes Service (AKS) cluster that's configured in accordance with the Payment Card Industry Data Security Standard (PCI-DSS).

> This article is part of a series. Read the [introduction](aks-pci-intro.yml) here.

Like any cloud solution, a PCI workload is subject to network, identity, and data threats. Common examples of sources that take advantage of workload and system vulnerabilities are viruses or software updates that produce undesirable results. Detect threats early and respond with mitigation in a timely manner. Build critical alerts for workload activities and extend those alerts to core system processes.  Antivirus or file-integrity monitoring (FIM) tools _must_ be always running. Have an accountable response plan and a team that investigates the alerts and takes action. 

> [!IMPORTANT]
>
> The guidance in this article builds on the [AKS baseline architecture](/azure/architecture/reference-architectures/containers/aks/secure-baseline-aks). That architecture based on a hub and spoke topology. The hub virtual network contains the firewall to control egress traffic, gateway traffic from on-premises networks, and a third network for maintainence. The spoke virtual network contains the AKS cluster that provides the card holder environment (CDE) and hosts the PCI DSS workload. 
>
> ![GitHub logo](../../../_images/github.png) [GitHub: Azure Kubernetes Service (AKS) Baseline Cluster for Regulated Workloads](https://github.com/mspnp/aks-baseline-regulated) demonstrates a regulated environment. The implementation illustrates the set up malware scanning tools. Every node in the cluster (in-scope and out-of-scope) has placeholder `DaemonSet` deployments for antivirus, FIM, Kubernetes-aware security agent (Falco), and reboot agent (kured). Place your choice of software in this deployment.


## Maintain a Vulnerability Management Program

**Requirement 5**&mdash;Protect all systems against malware and regularly update anti-virus software or programs 

|Requirement|Responsibility|
|---|---|
|[Requirement 5.1](#requirement-51)|Deploy anti-virus software on all systems commonly affected by malicious software (particularly personal computers and servers).|
|[Requirement 5.2](#requirement-52)|Ensure that all anti-virus mechanisms are maintained as follows:|
|[Requirement 5.3](#requirement-53)|Ensure that anti-virus mechanisms are actively running and cannot be disabled or altered by users, unless specifically authorized by management on a case-by-case basis for a limited time period.|
|[Requirement 5.4](#requirement-54)|Ensure that security policies and operational procedures for protecting systems against malware are documented, in use, and known to all affected parties.|


**Requirement 6**&mdash;Develop and maintain secure systems and applications

|Requirement|Responsibility|
|---|---|
|[Requirement 6.1](#requirement-61)|Establish a process to identify security vulnerabilities, using reputable outside sources for security vulnerability information, and assign a risk ranking (for example, as “high,” “medium,” or “low”) to newly discovered security vulnerabilities. |
|[Requirement 6.2](#requirement-62)|Ensure that all system components and software are protected from known vulnerabilities by installing applicable vendor-supplied security patches. Install critical security patches within one month of release. |
|[Requirement 6.3](#requirement-63)|Develop internal and external software applications (including web-based administrative access to applications) securely, as follows:
|
|[Requirement 6.4](#requirement-64)|Follow change control processes and procedures for all changes to system components. The processes must include the following:|
|[Requirement 6.5](#requirement-65)|Address common coding vulnerabilities in software-development processes as follows:|
|[Requirement 6.6](#requirement-66)|For public-facing web applications, address new threats and vulnerabilities on an ongoing basis and ensure these applications are protected against known attacks by either of the following methods:|
|[Requirement 6.7](#requirement-67)|Ensure that security policies and operational procedures for developing and maintaining secure systems and applications are documented, in use, and known to all affected parties.|

***

### Requirement 5.1
Deploy anti-virus software on all systems commonly affected by malicious software (particularly personal computers and servers).

#### Your responsibilities

Security agents are software that monitor the system and can help detect threats early. Because AKS is a managed service, AKS control plane prohibits certain operations. For example, you cannot install and run virtual machine scale set agents directly on VM nodes. 

So, you have to deploy a security agent that will run in a pod on every node. There are several third-party software specialized for Kubernetes. Popular choices include Twistlock, Aquasec, and others. There are also open-source options such as Falco. When deployed, they run as agents that look for unusual cluster activities and can generate reports and alerts.

> [!IMPORTANT]
> It's your responsibility to protect the workload, infrastructure, and the deployment pipelines by choosing an appropriate software. Do due dilligence in understanding the feature set offered by each software and the depth of scanning that it can do. Consider software developed by reputable vendors.

In addition to the cluster, also protect these components: 
- Jump boxes.
- Build agents.
- Container images


#### Requirement 5.1.1
Ensure that anti-virus programs are capable of detecting, removing, and protecting against all known types of malicious software.

##### Your responsibilities
Some threats can get injected through malicious software. An antimalware software is a security agent that can protect the system from known virus attacks and continuously monitor for new threats. 

> [!IMPORTANT]
>
> The reference implementation provides a placeholder `DaemonSet` deployment to run an antimalware agent. The agent will run on every node VM in the cluster. Place your choice of antimalware software in this deployment.

Choose antimalware software that is specialized in Kubernetes and containers. Some third-party options are Twistlock and Aquasec. In AKS, traditional agent-based VM solutions are not permitted including Azure Defender for servers.

The software should block common threats and monitor new threats. Make sure the software is regularly updated, tested, and replaced if found unsuitable. 

Security agents run with high privileges. This means they scan everything that runs in the cluster not just the workload. They must not become a data exfiltration source. Also, supply chain attacks are common for containers. Use defense-in-depth strategies and make sure the software and all the dependencies are trusted. 

#### Requirement 5.1.2
For systems considered to be not commonly affected by malicious software, perform periodic evaluations to identify and evaluate evolving malware threats in order to confirm whether such systems continue to not require anti-virus software.

##### Your responsibilities
Run the security agent in the cluster that scans all user and system node pools. Even though AKS uses system node pools for its runtime system binaries, the underlying compute is still your responsibility. Also run the software on external assets that participate in cluster operations. Some examples include jump boxes, build agents, and container images that interact with the cluster. 

When scanning, the agent should not block or interfere with the critical operations of the cluster, such as by locking files.

### Requirement 5.2
Ensure that all anti-virus mechanisms are maintained as follows:
- Are kept current,
- Perform periodic scans
- Generate audit logs which are retained per PCI DSS Requirement 10.7.

#### Your responsibilities
TBD
<Ask Chad: Need info.>


### Requirement 5.3
Ensure that anti-virus mechanisms are actively running and cannot be disabled or altered by users, unless specifically authorized by management on a case-by-case basis for a limited time period. 

#### Your responsibilities
You're responsible for setting up monitoring and alerting of the security agent. Build critical alerts for not only the workload but also the core system processes. The agent  _must_ be running at all times. Respond to the alerts raised by the antimalware software.

- Keep a log trail of scanning activities. Ensure the scanning process does not log any cardholder data scraped from disk or memory. 
- Set alerts for activities that might cause unexpected lapse in compliance. The alerts shouldn't be turned off inadvertently.
- Restrict the permissions to modify the deployment of the agent (and other critical security tooling). Keep those permissions separate from the workload deployment permissions.

### Requirement 5.4
Ensure that security policies and operational procedures for protecting systems against malware are documented, in use, and known to all affected parties

#### Your responsibilities
It's critical that you maintain thorough documentation about the process and policies.

<Ask Chad: What specific documentation should be maintained here. >

***

### Requirement 6.1
Establish a process to identify security vulnerabilities, using reputable outside sources for security vulnerability information, and assign a risk ranking (for example, as “high,” “medium,” or “low”) to newly discovered security vulnerabilities. 

#### Your responsibilities

"In AKS, users can use Azure Container Registry in combination with continuous scanning in Azure Security Center to identify vulnerable images and applications at various risk level. More details about image scan and risk control is available at: https://docs.microsoft.com/en-us/azure/security-center/container-security.

Customer will be responsible for putting appropriate practices in place to ensure monitoring of 3rd party container-aware solutions.

Software patches can introduce vulnerabilities. Make sure that patches are safe. Patches must be checked and installed by an account with critical access privileges. 

Use file-integrity monitoring (FIM) tools that detect file changes and send notifications. Monitor those notifications to make sure unauthorized additions, modifications, and deletions aren't made.

> [!TIP]
>
>The reference implementation provides a placeholder `DaemonSet` deployment to run a FIM tool. The software will run on every node VM. Place your choice of software in this deployment.


### Requirement 6.2
Ensure that all system components and software are protected from known vulnerabilities by installing applicable vendor-supplied security patches. Install critical security patches within one month of release. 

#### Your responsibilities

- Weekly, AKS provides new images for the user node pool. Those images aren't applied automatically. Apply them as soon as they're available. You can  update manually or automatically through Node Image Update. For more information, see Azure Kubernetes Service (AKS) node image upgrade the AKS Release Notes.

    For the AKS-managed control plane, AKS installs or upgrades the security patches. This does not include the system node pools. 
    
    <Ask Chad: Who's responsible for the system node pools>

- Every 24 hours, AKS nodes automatically download and install operating system and security patches, individually. Your firewall must not block this traffic if you want to receive those updates.

    Consider enabling reporting capabilities on the security agent to get information about the applied updates. 
    Some security updates require a reboot. Be sure to review the alerts and take the action to ensure minimum or zero application downtime with those reboots. An open-source option to perform reboots in a controlled manner is Kured (Kubernetes reboot daemon).

- Extend the patching process to resources outside the cluster that you provision such as jump boxes, build agents, and so on.
### Requirement 6.3
 Develop internal and external software applications (including web-based administrative access to applications) securely, as follows:
- In accordance with PCI DSS (for example, secure authentication and logging)
- Based on industry standards and/or best practices.
- Incorporating information security throughout the software-development life cycle Note: this applies to all software developed internally as well as bespoke or custom software developed by a third party.

#### Your responsibilities
Integrate and prioritize security choices as part of the workload lifecycle and operations. 

There are several industry frameworks that map to the lifecycle such as the [NIST](https://www.nist.gov/cyberframework) framework. NIST Functions—Identify, Protect, Detect, Respond, Recover provide strategies for  preventive controls in each phase.

Microsoft SDL (Security Development Lifecycle) provides best practices, tools, and processes for security throughout the phases of the development process. Microsoft SDL practices are followed for all Azure services including AKS. strictly internally in how we build software at Microsoft. We also follow Operational Security Assurance (OSA) framework for operating cloud services. Ensure you have a similar processes. These practices are published to help you secure your applications. 

- [Microsoft SDL](https://www.microsoft.com/securityengineering/sdl/practices).
- [Microsoft OSA](https://www.microsoft.com/securityengineering/osa)

#### Requirement 6.3.1
Remove development, test and/or custom application accounts, user IDs, and passwords before applications become active or are released to customers.

##### Your responsibilities
TBD

#### Requirement 6.3.2
Review custom code prior to release to production or customers in order to identify any potential coding vulnerability (using either manual or automated processes) to include at least the following:
- Code changes are reviewed by individuals other than the originating code author, and by individuals knowledgeable about code-review techniques and secure coding practices.
- Code reviews ensure code is developed according to secure coding guidelines
- Appropriate corrections are implemented prior to release.
- Code-review results are reviewed and approved by management prior to release.

##### Your responsibilities
All software installed in the cluster is sourced from your container registry. Similar to the application code, have processes and people scrutinize Azure and third-party images (DockerFile and OCI). Also 

- Start scanning container images from the initial stages when the cluster is created. Make the scanning process a part of your continuous integration/continuous deployment pipelines. 

    Ensure your deployment pipelines are gated in such a way that both cluster bootstrapping images and your workload have passed through a review and/or quarantine gate. Maintain history about how and what processes were used before they were pulled to the cluster.

- Usually images contain more binaries than what are required. Reducing the image size not only has performance benefits but also will limit the attack surface. For example, using distroless will minimize the base Linux images.
- Use static analysis tools that the integrity of the DockerFile and the manifests. Some third-party options are Dockle and Trivy.
- Only use signed images. 
- Understand (and accept) the base image provided by Azure and how it complies with CIS benchmarks.

Azure Container Registry with continuous scanning in Azure Security Center will help identify vulnerable images and various risks it can pose to the workload. For more information about image scan and risk control, see [Container security](/azure/security-center/container-security). 


### Requirement 6.4
 Follow change control processes and procedures for all changes to system components. The processes must include the following:
#### Your responsibilities
Make sure you document change control processes and design the deployment pipelines according to those processes. Have additional processes for detecting situations where the processes and actual pipelines do not align.

#### Requirement 6.4.1
Separate development/test environments from production environments, and enforce the separation with access controls.
##### Your responsibilities

Maintain separate production and pre-production environments and roles that operate in those environments. 

- Do not use your production cluster for development/test purposes. For example, don't install "bridge to Kubernetes" in your production clusters. Use dedicated clusters for non-production workloads. 

- Production environments should not allow network access to pre-production environments, and vice versa.

- Use different identities for pre-production and production environments. 

    Use Azure AD groups for groups such as cluster administrators, or pipeline principals. Don't use generalized or common groups as access controls. Don't reuse those groups between pre-production and production clusters. One way is to use the cluster name (or other opaque identifier) in the group name, to be explicit on memberships.

    Use Azure RBAC roles appropriately between environments. Typically more roles and rights are assigned pre-production environments. 
    
    Pre-production-only identities (granted to pipelines or software engineering teams), should not be granted access in production. Conversely, any production-only identities (such as pipelines) should not be granted access in pre-production clusters.

    Do not use the same user-managed identity for any resource in pre-production and in production. This recommendation applies to all resources that support user-managed identity, not just the resource deployed in your cluster. As a rule, each Azure resource should have its own identity.

- Use just-in-time(JIT) access for hig-privilege access, including on pre-production clusters if possible. Use conditional access policies on both pre production and production clusters.

- Remove default configuration data, sample data, and well-known test data in the system before deploying to production. That data is used to perform end-to-end health checks and performance and correctness monitoring through simulated transactions. Do not use cardholder data for test purposes. 

#### Requirement 6.4.2
Separation of duties between development/test and production environments.
##### Your responsibilities

Maintain separate production and pre-production environments and roles that operate in those environments. 

- Do not use your production cluster for development/test purposes. For example, don't install "bridge to Kubernetes" in your production clusters. Use dedicated clusters for non-production workloads. 

- Production environments should not allow network access to pre-production environments, and vice versa.

- Use different identities for pre-production and production environments. 

    Use Azure AD groups for groups such as cluster administrators, or pipeline principals. Don't use generalized or common groups as access controls. Don't reuse those groups between pre-production and production clusters. One way is to use the cluster name (or other opaque identifier) in the group name, to be explicit on memberships.

    Use Azure RBAC roles appropriately between environments. Typically more roles and rights are assigned pre-production environments. 
    
    Pre-production-only identities (granted to pipelines or software engineering teams), should not be granted access in production. Conversely, any production-only identities (such as pipelines) should not be granted access in pre-production clusters.

    Do not use the same user-managed identity for any resource in pre-production and in production. This recommendation applies to all resources that support user-managed identity, not just the resource deployed in your cluster. As a rule, each Azure resource should have its own identity.

- Use just-in-time(JIT) access for hig-privilege access, including on pre-production clusters if possible. Use conditional access policies on both pre production and production clusters.

#### Requirement 6.4.3
Production data (live PANs) are not used for testing or development.
##### Your responsibilities

<Ask Chad: TODO: Do we have a "scrubbing data for PPE" document out on docs somewhere?>

#### Requirement 6.4.4
Removal of test data and accounts from system components before the system becomes active / goes into production.
##### Your responsibilities

Remove default configuration data, sample data, and well-known test data in the system before deploying to production. That data is used to perform end-to-end health checks and performance and correctness monitoring through simulated transactions. Do not use cardholder data for test purposes. 

#### Requirement 6.4.5
Change control procedures for the implementation of security patches and software modifications must include the following:
- 6.4.5.1 Documentation of impact.
- 6.4.5.2 Documented change approval by authorized parties.
- 6.4.5.3 Functionality testing to verify that the change does not adversely impact the security of the system.
- 6.4.5.4 Back-out procedures.

##### Your responsibilities

Here are some ways in which you can track changes:
- Documenting the infrastructure changes that are expected as a result of the security patches and software modifications. That process is easier with the infrastructure-as-code (IaC) approach. For example, with Azure Resource Manager template (ARM template) for deployment, you can preview the changes with a what-if operation. For more information, see [ARM template deployment what-if operation](/azure/azure-resource-manager/templates/template-deploy-what-if) for your infrastructure changes.
- Implementing gates in your deployment pipelines that validate that changes are approved for regular deployments. Document the justification for emergecy deployments where gates might have been bypassed.
- Testing the security affordances. Make sure synthetic transations are testing security (both allow and deny) concerns, and those synthetic tests are also running in pre-production environments. For infrastructure, a common approach is to redeploy a prior state as Blue-Green infrastructure. For workloads, including databases, have a strategy that works for your specific topology and is scoped to your units of deployment.
- Defining the levels and depth of changes. Make sure the team agrees on the definition of significant as opposed to minor changes. If practical, automate the discovery of some of those changes. Reviewers for the workload, infrastructure, and pipeline must have clear understanding of the levels and validate agaist those criteria. 

### Requirement 6.5
Address common coding vulnerabilities in software-development processes as follows:
- Train developers at least annually in up-to-date secure coding techniques, including how to avoid common coding vulnerabilities.
- Develop applications based on secure coding guidelines.
#### Your responsibilities
It's critical that teams that application teams and operations teams are educated, informed, and incentivized to support scanning activities of the workload and infrastructure. 
<TODO: What links do we have to share here?  OWSAP, MS Learn, Plurarlsight, LI Learning, etc?>

### Requirement 6.6
 For public-facing web applications, address new threats and vulnerabilities on an ongoing basis and ensure these applications are protected against known attacks by either of the following methods:
- Reviewing public-facing web applications via manual or automated application vulnerability security assessment tools or methods, at least annually and after any changes Note: This assessment is not the same as the vulnerability scans performed for Requirement 11.2.
- Installing an automated technical solution that detects and prevents web-based attacks (for example, a web-application firewall) in front of public-facing web applications, to continually check all traffic.
#### Your responsibilities
<Ask Chad>

### Requirement 6.7
Ensure that security policies and operational procedures for developing and maintaining secure systems and applications are documented, in use, and known to all affected parties.

#### Your responsibilities
<Ask Chad>
It's critical that you maintain thorough documentation about the processes and policies. Especially <Todo> People operating regulated enviroments must be educated, informed, and incentivized to support the security assurances. This is particularly important for people who are part of the approval process from a policy perspective.

## Next

Restrict access to cardholder data by business need to know. Identify and authenticate access to system components. Restrict physical access to cardholder data

> [!div class="nextstepaction"]
> [Implement Strong Access Control Measures](aks-pci-identity.yml)