---
title: Health modeling for mission-critical workloads on Azure
description: Reference architecture for a workload that is accessed over a public endpoint without additional dependencies to other company resources - Health modeling.
author: nielsams
categories: monitoring
ms.author: allensu
ms.date: 08/15/2022
ms.topic: conceptual
ms.service: architecture-center
ms.subservice: reference-architecture
ms.category:
  - monitoring
azureCategories:
  - monitoring  
summary: Reference architecture for a workload that is accessed over a public endpoint without additional dependencies to other company resources.
products:
  - azure-monitor
---

# Health modeling for mission-critical workloads

Monitoring applications and infrastructure is an important part of any infrastructure deployment. For a mission-critical workload, monitoring is a critical part of the deployment. Monitoring application health and key metrics of Azure resources helps you understand if the environment is working as expected.

To fully understand these metrics and evaluate the overall health of a workload requires a holistic understanding of all of the data monitored. A health model can assist with evaluation of the overall health status by displaying a clear indication of the health of the workload instead of raw metrics. The status is often presented as "traffic light" indicators such as red, green, or yellow. Representation of a health model with clear indicators makes it intuitive for an operator to understand the overall health of the workload and respond quickly to issues that arise.

Health modeling can be expanded into the following operational tasks for the mission-critical deployment:

- **Application Health Service** - Application component on the compute cluster that provides an API to determine the health of a stamp.

- **Monitoring** - Collection of performance and application counters that evaluate the health and performance of the application and infrastructure.

- **Alerting** - Actionable alerts of issues or outages in the infrastructure and application.

- **Failure analysis** - Breakdown and analysis of any failures including documentation of root cause.

Taken together, these tasks make up a comprehensive health model for the mission-critical infrastructure. Development of a health model can and should be an exhaustive and integral part of any mission-critical deployment.

## Application Health Service

The Application Health Service (HealthService) is an application component that resides with the Catalog Service (CatalogService) and the Background Processor (BackgroundProcessor) within the compute cluster. The **HealthService** provides a REST API for Azure Front Door to call to determine the health of a stamp. The **HealthService** is a complex component that reflects the state of dependencies, in addition to it's own.

When the compute cluster is down, the health service won't respond. When the services is up and running, it performs periodic checks against the following components in the infrastructure:

- It attempts to do a simple query against Cosmos DB.

- It attempts to send a message to Event Hub. The message is filtered out by the background worker.

- It looks up a state file in the storage account. This file can be used to turn off a region, even while the other checks are still operating correctly.

All health check results are cached in memory for a configurable number of seconds, by default 10. The cached results in not every call to the API results in backend calls. This operation does add a small potential latency in detecting outages. Caching the results reduces additional cluster load generated by health checks.

### Configuration

The **HealthService** and the **CatalogService** have configuration settings common between the components except for the following settings used exclusively by the **HealthService**:

| Setting | Value |
| ------- | ----- |
| **`HealthServiceCacheDurationSeconds`** | Controls the expiration time of memory cache, in seconds. |
| **`HealthServiceStorageConnectionString`** | Connection string for the Storage Account where the status file should be present. |
| **`HealthServiceBlobContainerName`** | Storage Container where the status file should be present. |
| **`HealthServiceBlobName`** | Name of the status file - health check will look for this. |
| **`HealthServiceOverallTimeoutSeconds`** | Timeout for the whole check - defaults to 3 seconds. If the check doesn't finish in this interval, the service reports unhealthy. |

### Implementation

All checks are performed asynchronously and **in parallel**. If either of them fails, **the whole stamp will be considered unavailable.**

Check results are cached in memory, using the standard, non-distributed ASP.NET Core **`MemoryCache`**. Cache expiration is controlled by **`SysConfig.HealthServiceCacheDurationSeconds`** and is set to 10 seconds by default.

> [!NOTE]
> The **`SysConfig.HealthServiceCacheDurationSeconds`** configuration setting reduces the additional load generated by health checks as not every request will result in downstream call to the dependent services.

The following table details the health checks for the components in the infrastructure:

| Component | Health check |
| --------- | ------------ |
| **Storage account Blob** | The blob check currently serves two purposes: </br> 1. Test if it's possible to reach Blob Storage. The storage account is used by other components in the stamp and is considered a critical resource. </br> 2. Manually "turn off" a region by manipulating (i.e. deleting) the state file. </br> A design decision was made that the check would **only look for a presence of a state file** in the specified blob container. The content of the file isn't processed. There is a possibility to setup a more sophisticated system that reads the content of the file and return different status based on the content of the file. </br> Examples of content are **HEALTHY**, **UNHEALTHY**, and **MAINTENANCE**. </br> Removal of the state file will disable the stamp. Ensure the health file is present after deploying the application. Absence of the health file will cause the service to always respond with **UNHEALTHY**. Front Door won't recognize the backend as available. </br> The file is created by Terraform and should be present after the infrastructure deployment. |
| **Event Hub** | Event Hub health reporting is handled by the **`EventHubProducerService`**. This service reports healthy if it's able to send a new message to Event Hub. For filtering, this message has an identifying property added to it: </br> **`HEALTHCHECK=TRUE`** </br> This message is ignored on the receiving end. The **`AlwaysOn.BackgroundProcessor.EventHubProcessorService.ProcessEventHanderAsync()`** configuration setting checks for the **`HEALTHCHECK`** property. |
| **Cosmos DB** | Cosmos DB health reporting is handled by the **`CosmosDbService`**, which reports healthy if it is: </br> 1. Able to connect to Cosmos DB database and perform a simple query. </br> 2. Able to write a test document to the database. </br> The test document has a very short Time-to-Live set, Cosmos DB automatically removes it. </br> The **HealthService** performs two separate probes. The two probes ensure that if Cosmos DB is in a state where reads still work, but writing documents doesn't', an alert can be triggered. |

#### Cosmos DB queries

For the Read-only query, the following query is being used, which doesn't fetch any data and doesn't have large impact on overall load:

```sql
SELECT GetCurrentDateTime ()
```

The write query creates a dummy ItemRating with minimum content:

```csharp
var testRating = new ItemRating()
{
    Id = Guid.NewGuid(),
    CatalogItemId = Guid.NewGuid(), // Create some random (=non-existing) item id
    CreationDate = DateTime.UtcNow,
    Rating = 1,
    TimeToLive = 10 // will be auto-deleted after 10sec
};

await AddNewRatingAsync(testRating);
```

## Monitoring

## Alerting

## Failure analysis


## Next steps

Deploy the reference implementation to get a full understanding of the resources and their configuration used in this architecture.

> [!div class="nextstepaction"]
> [Implementation: Mission-Critical Online](https://github.com/Azure/Mission-Critical-Online)
