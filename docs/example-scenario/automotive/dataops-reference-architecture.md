# Data Operations (DataOps) Reference Architecture

This article outlines the different Azure building blocks that can help with the development of Automated Driving.  Data Operations (AVOps) reference architecture provides recommendations as a quick starter for anyone wanting to development solutions on Azure for Automated Driving (AD).

## Architecture

![AVOps Reference architecture.](.\images\high-level-architecture-avops.png)

DataOps (Data Operations) is a set of practices, processes, and tools aimed at improving the quality, speed, and reliability of data operations.  The goal of the DataOps flow for automated driving is to ensure that the data used to control the vehicle is of high quality, accurate, and reliable. By following a consistent DataOps flow, organizations can improve the speed and accuracy of their data operations and make better decisions to control their autonomous vehicles.  

Data operations in the context of automated driving refers to the processes and techniques used to collect, clean, store, manipulate, and analyze vast amounts of data generated by various sensors and systems in an automated vehicle. The goal of these operations is to extract useful information that can inform decision-making, enabling the vehicle to safely navigate its environment and interact with other road users.

Data operations in automated driving typically involve:

1. Data Collection: Collecting data from various sources such as cameras, lidar, radar, GPS, and other sensors.
1. Data Cleaning: Removing noise, correcting errors, and handling missing data to ensure that the data is accurate and reliable.
1. Data Storage: Storing the vast amounts of data generated by an autonomous vehicle in an efficient and scalable manner, such as using cloud-based storage solutions or in-vehicle data storage systems.
1. Data Manipulation: Transforming the data into a format that can be analyzed and used for decision-making. This includes techniques such as data compression, filtering, and feature extraction.
1. Data Analysis: Analyzing the data to extract useful information, such as identifying obstacles, recognizing traffic signs, and making predictions about future road conditions.

Data operations play a critical role in the development and deployment of autonomous vehicles, as they enable the vehicle to make informed decisions based on its surroundings and interact with the environment in a safe and effective manner.

The reference architecture contains guidance about these logical building blocks and processes for DataOps, technology recommendations, partner, or open-source solutions for specific areas like simulation and data models. 

### Data flow

![AVOps Reference architecture.](.\images\high-level-architecture-avops.png)
*Download a [Visio file](https://arch-center.azureedge.net/[AVOps].vsdx) of this architecture.*

Here is the high-level process flow of data through the reference architecture:
1. Measurement data is recorded by loggers in the vehicle which can include different data streams for different sensors (camera, radar, ultrasound, lidar..) and vehicle telemetry, stored on a data box in the vehicle and then uploaded to the landing data lake. This could be via [Azure Data Box](https://learn.microsoft.com/en-us/azure/databox/), [Azure Stack Edge](https://learn.microsoft.com/en-us/azure/databox-online/) or through a dedicated connection such as [Azure ExpressRoute](https://learn.microsoft.com/en-us/azure/expressroute/).  
    1. Measurements could also be synthetic data from simulations or from any other source (the common data formats for measurements are MDF4, TDMS and Rosbag).  
    2. Ingested measurements are validated and data quality checks (e. g. checksum etc.) are performed to remote low quality data.
    3. Besides raw information meta-data (i.e. information captured by a test driver who documents a drive) are extracted and stored in a centralized meta-data catalog which helps downstream processes to identify specific scenes and sequences
1. Data then goes through an extract, transform, load (ETL) pipeline where Raw and binary data are stored on [Azure Data Lake Gen2](https://learn.microsoft.com/en-us/azure/storage/blobs/data-lake-storage-introduction). Meta-data are stored in [Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db) (depending on final scenario extended by [Azure Data Explorer](https://docs.microsoft.com/azure/data-explorer/data-explorer-overview) and [Azure Cognitive Search](https://learn.microsoft.com/en-us/azure/cognitive-services/))
1. Data enrichment helps improve the accuracy and reliability of the data by adding additional information, insights and context to the data collected.
1. Extracted measurement data are provided to labeling partners (Human in the Loop) via [Azure Data Share](https://learn.microsoft.com/en-us/azure/data-share/)  and / or labeled via Auto Labeling (usually covered by 3rd party partners) which are stored on separate Data Lake account (“Label Lake”)
1. Labeled data sets are provided to further [MLOps](#mlops) processes, mainly to create a perception and sensor fusion model used by autonomous vehicles to detect scenes (like lane change, blocked roads, pedestrian, traffic lights, traffic signs etc.)
1. Trained models are validated via Open Loop and Closed Loop testing
1. Visualization of ingested and processed Rosbag file can be served by tools such as [Foxglove](https://foxglove.dev/) running on [Azure Kubernetes Service](https://learn.microsoft.com/en-us/azure/aks/intro-kubernetes) or [Azure Container Instances](https://learn.microsoft.com/en-us/azure/container-instances/)

The image below shows an example scenario of an offline/online collection of vehicle data to a data lake.  

![Data Collection](.\images\data-collection.png)
### AVOps Platform Layer
As AVOps is a complex architecture that includes many organizations, 3rd parties, various roles, and various stages in the development of Automated Vehicles, thus implementing a good governance model is imperative. Utilizing the guidance from the [Azure Cloud Adoption Framework](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/), AVOps utilizes the concept within the Azure Cloud Adoption Framework called the [Azure Landing Zone](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/).  The Platform Layer can be thought of as the Platform Landing Zone that represent key services such as scale, security governance, networking, and identity.  In addition, the Platform Layer handles Infrastructure Provisioning, Cost Management, Metadata and Data Catalog, Lineage, Overall Orchestration and Event Handling.  These services benefit from being consolidated for efficiency and ease of operations.

For that reason, a platform layer has a set of these responsibilities:
- Providing ARM / Bicep templates incl. standard services like storage and compute used by each area and sub-area of the AVOps reference architecture 
- Central Service Bus / Event Hub instances with allows an event driven orchestration of the AVOps data loop 
- Meta-Data Catalog 
- Capabilities for E2E lineage and traceability across all AVOps components 

![Platform Layer](.\images\platform-layer.png)

### DataOps
DataOps (Data Operations) is a set of practices, processes, and tools aimed at improving the quality, speed, and reliability of data operations.  The goal of the DataOps flow for autonomous driving is to ensure that the data used to control the vehicle is of high quality, accurate, and reliable. By following a consistent DataOps flow, organizations can improve the speed and accuracy of their data operations and make better decisions to control their autonomous vehicles.  

A future DataOps Reference Architecture will be available with more details.

### MLOps
MLOps is leveraged in several places of the AVOps reference architecture where machine learning comes into the picture:
- Feature Extraction Models (like CLIP, Yolo) to classify scenes (e.g. if pedestrian is part of the scene) during [DataOps](#dataops) pipeline 
- Auto Labeling Models to label ingested images / pictures, lidar and radar data 
- Perception and Computer Vision Models to detect objects and scenes
- Sensor Fusions Model that combines different sensor streams 
One of the main parts of the AVOps reference architecture is the development of the Azure Machine Learning based perception model that generates object detection model based on detected and extracted scenes. 

Transfer of containerized machine learning model to a format understood by SoC (system on a chip) hardware and validation / simulation software requires an additional step in the MLOps pipeline that needs support from SoC manufacturers.

### ValidationOps

Validation Operations (ValidationOps) involve testing the developed models in simulated environments via [managed scenarios](#scenario-management) to ensure they meet desired performance standards, accuracy, and safety requirements before expensive real-world environmental testing. The goal of the validation process in the cloud is to identify and address any potential issues before deploying the autonomous vehicle in a live environment. This may include:

1. Simulation validation: Cloud-based simulation ([Open Loop](#open-loop-testing)/[Closed Loop Testing](#closed-loop-testing-and-simulation)) environments allow for virtual testing of autonomous vehicle models, which can be run at scale and at a lower cost than real-world testing.
1. Performance validation: Cloud-based infrastructure provides the ability to run large-scale tests to evaluate the performance of autonomous vehicle models. This can include stress tests, load tests, and benchmarks.


In general, using the AVOps - ValidationOps reference for validation allows organizations to take advantage of the scalability, flexibility, and cost-effectiveness of cloud-based infrastructure, while also speeding up the time-to-market for autonomous vehicle models.

#### Open Loop testing
Re-Simulation is massively complex and has required years of development. Seeking government approval of Autonomous Driving (AD) raises strict requirements in areas such as safety, data privacy, data versioning and auditing. It can be considered an open loop test and validation system for AD functions. It processes recorded raw data from various car sensors through a graph in the cloud. The produced result can then be used to validate data processing algorithms or detect regressions. The OEMs combine the sensors together into a Directed acyclic graph that represents the real-world vehicle.
Re-simulation or “sensor reprocessing” is usually a large-scale embarrassingly parallel compute job that processes 10~100s PBs of data using tens of thousands of cores and requiring very high I/O throughput of >30GB/sec. Data sets are fused from multiple sensor types representing a singular view of what the on-vehicle computer vision systems “saw” when navigating the real world. An open loop test is where the performance of the algorithms is tested & validated against ground truth using replay and scoring. The output is used later in the workflow for algorithm training:
- Data sets sourced from test fleet vehicles that collect raw sensor data (E.g., camera, lidar, radar, etc.)
- Data volume is highly dependent on camera resolution and number of sensors on vehicle
- Re-Processing of Raw Data against different software releases of the devices
- Raw sensor data is directly sent to the sensor input interface of the sensor-software
- Output is compared with the output of previous SW-versions and is checked against bug fixing or new features like detecting new object types
- A second “re-injection” or “re-run” of the job increasingly performed after model & software are updated
- Ground truth data is used to validate the results
- Results are written to Storage and offloaded to Azure Data Explorer (for visualization)

#### Closed Loop testing and simulation
Closed loop testing of autonomous vehicles refers to testing their capabilities with real-time feedback from the environment. In other words, the vehicle's actions are based on both its pre-programmed behavior and the dynamic conditions it is encountering, and it adjusts its actions accordingly. This type of testing is typically done in a more complex and realistic environment and is used to assess the vehicle's ability to handle real-world scenarios, including dealing with unexpected situations. The goal of closed loop testing is to verify that the vehicle can operate safely and effectively in a variety of conditions, and to refine its control algorithms and decision-making processes as needed.

For Closed-Loop testing and simulations 3rd party and ISV applications can be integrated within the ValidationOps pipeline.

#### Scenario Management 
To validate the AD capabilities, a catalogue of specific real scenarios is required that can be used to simulate the behavior of AVs. The objective is to accelerate the creation of scenario catalogues, by automatically reading the route network, which is a part of a scenario, from publicly accessible and freely available digital maps. As part of the reference architecture open formats like [OPENDrive (xodr)](https://www.asam.net/standards/detail/opendrive/) should be supported. 3rd party tools could be utilized used for Scenario Management or CARLA can be considered as OSS light weight alternative that also supports OPENDrive format, see [carla-simulator/scenario_runner: Traffic scenario definition and execution engine](https://github.com/carla-simulator/scenario_runner).

### Components
#### DataOps Components
* [Azure Data Box](https://learn.microsoft.com/en-us/azure/databox/) used to transfer collected vehicle data to Azure through a regional carrier
* [Azure ExpressRoute](https://learn.microsoft.com/en-us/azure/expressroute/) extends on-premises network into the Microsoft cloud over a private connection
* [Azure Data Lake Gen2](https://learn.microsoft.com/en-us/azure/storage/blobs/data-lake-storage-introduction) used to data per stages (e.g. raw, extracted, etc)
* [Azure Data Factory](https://learn.microsoft.com/en-us/azure/data-factory/introduction) orchestrated data flow, performs ETL through [batch compute](https://learn.microsoft.com/en-us/azure/batch/), and data integration service that creates data-driven workflows for orchestrating data movement and transforming data 
* [Azure Batch](https://learn.microsoft.com/en-us/azure/batch/) runs large-scale applications such as for data wrangling, filtering and preparation of data, metadata extraction, and etc
* [Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db) used to store metadata results such as stored measurement
* [Azure Data Share](https://learn.microsoft.com/en-us/azure/data-share/) shares data with 3rd party organizations such as labeling companies in a safe and secure manner
* [Azure Data Bricks](https://learn.microsoft.com/azure/databricks/) provides a set of tool to maintain enterprise-grade data solutions at scale. Required for long-running operations on large amounts of vehicle data.  Used as an analytics workbench for a Data Engineer
* [Azure Synapse](https://learn.microsoft.com/en-us/azure/synapse-analytics/overview-what-is) accelerates time to insight across data warehouses and big data systems.
* [Azure Cognitive Search](https://learn.microsoft.com/en-us/azure/cognitive-services/) - Provides the data catalog search services

#### MLOps Components
* [Azure Machine Learning](https://learn.microsoft.com/en-us/azure/machine-learning/overview-what-is-azure-machine-learning) used to develop machine learning algorithms such as feature extraction, auto labeling, object detection and classification, and sensor fusion.  
* [Azure DevOps](https://learn.microsoft.com/en-us/azure/devops/user-guide/what-is-azure-devops?view=azure-devops) used as the main tool for DevOps practice that includes CI/CD, testing and automation.
* [Github](https://github.com/) as an alternative, Github could be used  as the main tool for DevOps practice that includes CI/CD, testing and automation.
* [Azure Container Registry](https://learn.microsoft.com/en-us/azure/container-registry/) allows you to build, store, and manage container images and artifacts in a private registry for all types of container deployments

#### ValidationOps Components
* [Azure Kubernetes Service](https://learn.microsoft.com/en-us/azure/aks/intro-kubernetes) runs large-scale applications batch inference for open-loop validation within a re-sim framework. For access measurement files, recommended to use BlobFuse2.  Alternative is to use NFS but performance would be affected(add more details)
* [BlobFuse2](https://learn.microsoft.com/en-us/azure/storage/blobs/blobfuse2-what-is)
* [Azure Batch](https://learn.microsoft.com/en-us/azure/batch/) runs large-scale applications batch inference for open-loop validation within a re-sim framework
* [Azure Data Explorer](https://docs.microsoft.com/azure/data-explorer/data-explorer-overview) provides exploration of measurements and KPI (i.e. re-simulation and job runs).


## Scenario details

How do we operate a backend to enable Autonomous Vehicles at scale? 
Autonomous Vehicles operations (AVOps) usually require a huge amount of storage and compute to
- Capture and process data and scenes from test vehicles (as learning material for perception model required by vehicles to drive autonomously) 
- Train perception model to recognize the environment as base functionality to drive autonomously 
- Perform safety validation based on open and closed loop simulations

AVOps allows organizations to take advantage of the scalability, flexibility, and cost-effectiveness of cloud-based infrastructure, while also speeding up the time-to-market for Automated Vehicles.


Challenges

- Data collection: collecting and analyzing large amounts of data to identify patterns and improve the vehicle's performance over time.  Majority of costs for vehicle development is due to data management and testing.
- Data management: handling the large amounts of data generated by the vehicle's sensors and systems while determining what data is useful.
- Scenario coverage: ensuring the vehicle has been tested in a wide range of scenarios, including different weather conditions, lighting, and road conditions.
- Complexity: managing the large and diverse set of algorithms and systems required for autonomous operation.
- Verification and validation: thoroughly testing the software to ensure it behaves as expected in a wide range of scenarios and environments.
- Data availability:  globally dispersed teams and 3rd parties make sharing of data a challenge.

### Potential use cases

- Automotive OEMs, Tier1s, and/or ISVs that are developing solutions for automated driving 

## Considerations

These considerations implement the pillars of the Azure Well-Architected Framework, which is a set of guiding tenets that can be used to improve the quality of a workload. For more information, see [Microsoft Azure Well-Architected Framework](/azure/architecture/framework).

### Reliability

Reliability ensures your application can meet the commitments you make to your customers. For more information, see [Overview of the reliability pillar](/azure/architecture/framework/resiliency/overview).

* Auto scale and reserved instances
* Geo redundancy

### Security

Security provides assurances against deliberate attacks and the abuse of your valuable data and systems. For more information, see [Overview of the security pillar](/azure/architecture/framework/security/overview).

It's important to understand the division of responsibility between the automotive OEM and Microsoft. In the vehicle, the OEM owns the whole stack, but as the data moves to the cloud, some responsibilities transfer to Microsoft. Azure platform-as-a-service (PaaS) provides built-in security on the physical stack, including the operating system. You can apply the following capabilities on top of the infrastructure security components.

* Private endpoints for network security. For more information, see [Private endpoints for Azure Data Explorer](https://learn.microsoft.com/en-us/azure/data-explorer/security-network-private-endpoint) and [Allow access to Azure Event Hubs namespaces via private endpoints](https://learn.microsoft.com/en-us/azure/event-hubs/private-link-service).
* Encryption at rest and in transit.
* Identity and access management that uses Azure Active Directory (Azure AD) identities and [Azure AD Conditional Access](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access) policies.
* [Row Level Security (RLS)](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access) for Azure Data Explorer.
* Infrastructure governance that uses [Azure Policy](https://azure.microsoft.com/services/azure-policy).
* Data governance that uses [Microsoft Purview](https://azure.microsoft.com/services/purview).
* Securing the connection of the vehicles - certificate management
* Verify explicitly: Always authenticate and authorize based on all available data points
* Use least privilege access: Limit user access with Just-In-Time and Just-Enough-Access (JIT/JEA), risk-based adaptive policies, and data protection
* Assume breach: Minimize blast radius and segment access. Verify end-to-end encryption and use analytics to get visibility, drive threat detection and improve defenses
* Secure development lifecycle will be used
* These points will drive a Zero Trust Strategy
* It should be clarified if security relevant events must be stored in a central security log analytics workspace
* It should be clarified if “bring your own key” (BYOK) is required. Some customers in automotive sectors are using BYOK


### Cost optimization

Cost optimization is about looking at ways to reduce unnecessary expenses and improve operational efficiencies. For more information, see [Overview of the cost optimization pillar](/azure/architecture/framework/cost/overview).

Challenges:

There are several strategies that organizations can use to reduce costs associated with autonomous driving development:

1. Optimize cloud infrastructure: Careful planning and management of cloud infrastructure can help reduce costs, such as choosing cost-effective instance types and scaling infrastructure to meet changing workloads. Utilizing the guidance from the [Azure Cloud Adoption Framework](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/) is recommended.
1. Use spot instances: Spot instances allow organizations to bid on spare capacity, which can result in significant cost savings compared to on-demand instances.
1. Leverage auto-scaling: Auto-scaling enables organizations to automatically adjust their cloud infrastructure based on demand, reducing the need for manual intervention and helping to keep costs in check.
1. Utilize cost-effective storage: Consider how long the data should be stored hot/cold/cold.  Storage can be a significant cost for autonomous driving development, so it's important to choose cost-effective storage options, such as cold storage or infrequent access storage.
1. Utilize cost management and optimization tools: [Azure Cost Management](https://azure.microsoft.com/en-us/products/cost-management/#overview) provides  cost management and optimization tools that can help organizations identify and address areas where costs can be reduced, such as identifying unused or underutilized resources.
1. Consider Azure Services: Organizations can use Azure services, such as [Azure Machine Learning](https://learn.microsoft.com/en-us/azure/machine-learning/overview-what-is-azure-machine-learning) to build and train autonomous driving models, which can be more cost-effective than building and maintaining in-house infrastructure.
1. Use shared resources: When possible, organizations can use shared resources, such as shared databases or shared compute resources, to reduce costs associated with autonomous driving development.  [Platform Layer](#avops-platform-layer) aims to solve this challenge by implementing a central bus, event hub and a Meta-Data Catalog.  In addition, services such as [Azure Data Share](https://learn.microsoft.com/en-us/azure/data-share/) help organizations achieve this goal.

By following these strategies, organizations can reduce the costs associated with autonomous driving development in the cloud, freeing up resources that can be used to further enhance the development process.
### Operational excellence

Operational excellence covers the operations processes that deploy an application and keep it running in production. For more information, see [Overview of the operational excellence pillar](/azure/architecture/framework/devops/overview).

### Performance efficiency

Performance efficiency is the ability of your workload to scale to meet the demands placed on it by users in an efficient manner. For more information, see [Performance efficiency pillar overview](/azure/architecture/framework/scalability/overview).

### Contributors 
*This article is maintained by Microsoft. It was originally written by the following contributors.*

Principal authors: > Only the primary authors. Listed alphabetically by last name. Use this format: Fname Lname. If the article gets rewritten, keep the original authors and add in the new one(s).

 - [Ryan Matsumura](https://www.linkedin.com/in/ryan-matsumura-4167257b/) | Senior Program Manager
 - [Jochen Schroeer](https://www.linkedin.com/in/jochen-schroeer/) | Lead Architect (Service Line Mobility)

Other contributors: 

 - [David Peterson](https://www.linkedin.com/in/david-peterson-64456021/) | Chief Architect
 - [Gabriel Sallah](https://www.linkedin.com/in/gabrielsallah/) | HPC/AI Global Black Belt Specialist

*To see non-public LinkedIn profiles, sign in to LinkedIn.*

## Related resources

Related architecture guides:

* [Data analytics for automotive test fleets](https://learn.microsoft.com/en-us/azure/architecture/industries/automotive/automotive-telemetry-analytics)
